/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * @param {?} element
 * @param {?} callback
 * @return {?}
 */
export function waitForAnimation(element, callback) {
    requestAnimationFrame(function () {
        /** @type {?} */
        var computedStyle = window.getComputedStyle(element);
        if (computedStyle.animationName !== 'none' &&
            computedStyle.animationPlayState === 'running') {
            return once(element, 'animationend', callback);
        }
        callback();
    });
}
/**
 * @param {?} element
 * @param {?} eventName
 * @param {?} listener
 * @return {?}
 */
function once(element, eventName, listener) {
    element.addEventListener(eventName, function listenOnce(e) {
        element.removeEventListener(eventName, listenOnce);
        return listener(e);
    });
}
/** @type {?} */
export var closest = ((/** @type {?} */ (window))).Element && Element.prototype.closest ?
    function (el, s) { return el.closest(s); } :
    function closest(self, s) {
        /** @type {?} */
        var matches = (((/** @type {?} */ (self))).document || self.ownerDocument).querySelectorAll(s);
        /** @type {?} */
        var i;
        /** @type {?} */
        var el = self;
        do {
            i = matches.length;
            while (--i >= 0 && matches.item(i) !== el) { }
            ;
        } while ((i < 0) && (el = (/** @type {?} */ (el.parentElement))));
        return el;
    };
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculatePosition(trigger, dropdown, _a) {
    var horizontalPosition = _a.horizontalPosition, verticalPosition = _a.verticalPosition, matchTriggerWidth = _a.matchTriggerWidth, previousHorizontalPosition = _a.previousHorizontalPosition, previousVerticalPosition = _a.previousVerticalPosition;
    // Collect information about all the involved DOM elements
    /** @type {?} */
    var scroll = { left: window.pageXOffset, top: window.pageYOffset };
    var _b = trigger.getBoundingClientRect(), triggerLeft = _b.left, triggerTop = _b.top, triggerWidth = _b.width, triggerHeight = _b.height;
    var _c = dropdown.getBoundingClientRect(), dropdownHeight = _c.height, dropdownWidth = _c.width;
    /** @type {?} */
    var viewportWidth = window.innerWidth;
    /** @type {?} */
    var style = {};
    // Calculate drop down width
    dropdownWidth = matchTriggerWidth ? triggerWidth : dropdownWidth;
    if (matchTriggerWidth) {
        style.width = dropdownWidth;
    }
    // Calculate horizontal position
    /** @type {?} */
    var triggerLeftWithScroll = triggerLeft + scroll.left;
    if (horizontalPosition === 'auto') {
        // Calculate the number of visible horizontal pixels if we were to place the
        // dropdown on the left and right
        /** @type {?} */
        var leftVisible = Math.min(viewportWidth, triggerLeft + dropdownWidth) - Math.max(0, triggerLeft);
        /** @type {?} */
        var rightVisible = Math.min(viewportWidth, triggerLeft + triggerWidth) - Math.max(0, triggerLeft + triggerWidth - dropdownWidth);
        if (dropdownWidth > leftVisible && rightVisible > leftVisible) {
            // If the drop down won't fit left-aligned, and there is more space on the
            // right than on the left, then force right-aligned
            horizontalPosition = 'right';
        }
        else if (dropdownWidth > rightVisible && leftVisible > rightVisible) {
            // If the drop down won't fit right-aligned, and there is more space on
            // the left than on the right, then force left-aligned
            horizontalPosition = 'left';
        }
        else {
            // Keep same position as previous
            horizontalPosition = previousHorizontalPosition || 'left';
        }
    }
    if (horizontalPosition === 'right') {
        style.right = viewportWidth - (triggerLeftWithScroll + triggerWidth);
    }
    else if (horizontalPosition === 'center') {
        style.left = triggerLeftWithScroll + (triggerWidth - dropdownWidth) / 2;
    }
    else {
        style.left = triggerLeftWithScroll;
    }
    // Calculate vertical position
    /** @type {?} */
    var triggerTopWithScroll = triggerTop + scroll.top;
    if (verticalPosition === 'above') {
        style.top = triggerTopWithScroll - dropdownHeight;
    }
    else if (verticalPosition === 'below') {
        style.top = triggerTopWithScroll + triggerHeight;
    }
    else {
        /** @type {?} */
        var viewportBottom = scroll.top + self.window.innerHeight;
        /** @type {?} */
        var enoughRoomBelow = triggerTopWithScroll + triggerHeight + dropdownHeight < viewportBottom;
        /** @type {?} */
        var enoughRoomAbove = triggerTop > dropdownHeight;
        if (previousVerticalPosition === 'below' && !enoughRoomBelow && enoughRoomAbove) {
            verticalPosition = 'above';
        }
        else if (previousVerticalPosition === 'above' && !enoughRoomAbove && enoughRoomBelow) {
            verticalPosition = 'below';
        }
        else if (!previousVerticalPosition) {
            verticalPosition = enoughRoomBelow ? 'below' : 'above';
        }
        else {
            verticalPosition = previousVerticalPosition;
        }
        style.top = triggerTopWithScroll + (verticalPosition === 'below' ? triggerHeight : -dropdownHeight);
    }
    return { horizontalPosition: horizontalPosition, verticalPosition: verticalPosition, style: style };
}
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculateInPlacePosition(trigger, dropdown, _a) {
    var horizontalPosition = _a.horizontalPosition, verticalPosition = _a.verticalPosition;
    /** @type {?} */
    var dropdownRect;
    /** @type {?} */
    var positionData = {};
    if (horizontalPosition === 'auto') {
        /** @type {?} */
        var triggerRect = trigger.getBoundingClientRect();
        dropdownRect = dropdown.getBoundingClientRect();
        /** @type {?} */
        var viewportRight = window.pageXOffset + window.innerWidth;
        positionData.horizontalPosition = triggerRect.left + dropdownRect.width > viewportRight ? 'right' : 'left';
    }
    if (verticalPosition === 'above') {
        positionData.verticalPosition = verticalPosition;
        dropdownRect = dropdownRect || dropdown.getBoundingClientRect();
        positionData.style = { top: -dropdownRect.height };
    }
    return positionData;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE1BQU0sMkJBQTJCLE9BQWdCLEVBQUUsUUFBNEI7SUFDN0UscUJBQXFCLENBQUM7O1lBQ2hCLGFBQWEsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDO1FBRXBELElBQUksYUFBYSxDQUFDLGFBQWEsS0FBSyxNQUFNO1lBQ3RDLGFBQWEsQ0FBQyxrQkFBa0IsS0FBSyxTQUFTLEVBQUU7WUFDbEQsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNoRDtRQUVELFFBQVEsRUFBRSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDOzs7Ozs7O0FBRUQsY0FBYyxPQUFhLEVBQUUsU0FBaUIsRUFBRSxRQUEyQjtJQUN6RSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLG9CQUFvQixDQUFDO1FBQ3ZELE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFbkQsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDOztBQUVELE1BQU0sS0FBTyxPQUFPLEdBQ2hCLENBQUMsbUJBQUEsTUFBTSxFQUFPLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN0RCxVQUFDLEVBQUUsRUFBRSxDQUFDLElBQUssT0FBQSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFiLENBQWEsQ0FBQyxDQUFDO0lBQzFCLGlCQUFpQixJQUFhLEVBQUUsQ0FBUzs7WUFDbkMsT0FBTyxHQUFHLENBQUMsQ0FBQyxtQkFBQSxJQUFJLEVBQU8sQ0FBQyxDQUFDLFFB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QixFQUFFLHNDQUFnQjs7UUFDcEMsWUFBWTs7UUFDWixZQUFZLEdBQVEsRUFBRTtJQUUxQixJQUFJLGtCQUFrQixLQUFLLE1BQU0sRUFBRTs7WUFDN0IsV0FBVyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRTtRQUNqRCxZQUFZLEdBQUcsUUFBUSxDQUFDLHFCQUFxQixFQUFFLENBQUM7O1lBQzVDLGFBQWEsR0FBRyxNQUFNLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxVQUFVO1FBQzFELFlBQVksQ0FBQyxrQkFBa0IsR0FBRyxXQUFXLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztLQUM1RztJQUNELElBQUksZ0JBQWdCLEtBQUssT0FBTyxFQUFFO1FBQ2hDLFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUNqRCxZQUFZLEdBQUcsWUFBWSxJQUFJLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ2hFLFlBQVksQ0FBQyxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7S0FDcEQ7SUFDRCxPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGZ1bmN0aW9uIHdhaXRGb3JBbmltYXRpb24oZWxlbWVudDogRWxlbWVudCwgY2FsbGJhY2s6IChlPzogRXZlbnQpID0+IGFueSk6IHZvaWQge1xuICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgIGxldCBjb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCk7XG5cbiAgICBpZiAoY29tcHV0ZWRTdHlsZS5hbmltYXRpb25OYW1lICE9PSAnbm9uZScgJiZcbiAgICAgICAgY29tcHV0ZWRTdHlsZS5hbmltYXRpb25QbGF5U3RhdGUgPT09ICdydW5uaW5nJykge1xuICAgICAgcmV0dXJuIG9uY2UoZWxlbWVudCwgJ2FuaW1hdGlvbmVuZCcsIGNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICBjYWxsYmFjaygpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gb25jZShlbGVtZW50OiBOb2RlLCBldmVudE5hbWU6IHN0cmluZywgbGlzdGVuZXI6IChlOiBFdmVudCkgPT4gYW55KTogdm9pZCB7XG4gIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGZ1bmN0aW9uIGxpc3Rlbk9uY2UoZSkge1xuICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGxpc3Rlbk9uY2UpO1xuXG4gICAgcmV0dXJuIGxpc3RlbmVyKGUpO1xuICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IGNsb3Nlc3Q6IChlbGVtZW50OiBFbGVtZW50LCBzZWxlY3Rvcjogc3RyaW5nKSA9PiBFbGVtZW50IHwgbnVsbFxuICA9ICh3aW5kb3cgYXMgYW55KS5FbGVtZW50ICYmIEVsZW1lbnQucHJvdG90eXBlLmNsb3Nlc3QgP1xuICAgIChlbCwgcykgPT4gZWwuY2xvc2VzdChzKSA6XG4gICAgZnVuY3Rpb24gY2xvc2VzdChzZWxmOiBFbGVtZW50LCBzOiBzdHJpbmcpIHtcbiAgICAgIGxldCBtYXRjaGVzID0gKChzZWxmIGFzIGFueSkuZG9jdW1lbnQgfHwgc2VsZi5vd25lckRvY3VtZW50KS5xdWVyeVNlbGVjdG9yQWxsKHMpLFxuICAgICAgICBpLFxuICAgICAgZWwgPSBzZWxmO1xuICAgICAgZG8ge1xuICAgICAgICBpID0gbWF0Y2hlcy5sZW5ndGg7XG4gICAgICAgIHdoaWxlICgtLWkgPj0gMCAmJiBtYXRjaGVzLml0ZW0oaSkgIT09IGVsKSB7fTtcbiAgICAgIH0gd2hpbGUgKChpIDwgMCkgJiYgKGVsID0gZWwucGFyZW50RWxlbWVudCEpKTtcbiAgICAgIHJldHVybiBlbDtcbiAgICB9O1xuXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlUG9zaXRpb24oXG4gIHRyaWdnZXI6IEVsZW1lbnQsXG4gIGRyb3Bkb3duOiBFbGVtZW50LFxuICB7IGhvcml6b250YWxQb3NpdGlvbiwgdmVydGljYWxQb3NpdGlvbiwgbWF0Y2hUcmlnZ2VyV2lkdGgsIHByZXZpb3VzSG9yaXpvbnRhbFBvc2l0aW9uLCBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb24gfTogYW55KTogYW55IHtcbiAgLy8gQ29sbGVjdCBpbmZvcm1hdGlvbiBhYm91dCBhbGwgdGhlIGludm9sdmVkIERPTSBlbGVtZW50c1xuICBsZXQgc2Nyb2xsID0geyBsZWZ0OiB3aW5kb3cucGFnZVhPZmZzZXQsIHRvcDogd2luZG93LnBhZ2VZT2Zmc2V0IH07XG4gIGxldCB7XG4gICAgbGVmdDogdHJpZ2dlckxlZnQsXG4gICAgdG9wOiB0cmlnZ2VyVG9wLFxuICAgIHdpZHRoOiB0cmlnZ2VyV2lkdGgsXG4gICAgaGVpZ2h0OiB0cmlnZ2VySGVpZ2h0XG4gIH0gPSB0cmlnZ2VyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICBsZXQge1xuICAgIGhlaWdodDogZHJvcGRvd25IZWlnaHQsXG4gICAgd2lkdGg6IGRyb3Bkb3duV2lkdGhcbiAgfSA9IGRyb3Bkb3duLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICBsZXQgdmlld3BvcnRXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuICBsZXQgc3R5bGU6IGFueSA9IHt9O1xuXG4gIC8vIENhbGN1bGF0ZSBkcm9wIGRvd24gd2lkdGhcbiAgZHJvcGRvd25XaWR0aCA9IG1hdGNoVHJpZ2dlcldpZHRoID8gdHJpZ2dlcldpZHRoIDogZHJvcGRvd25XaWR0aDtcbiAgaWYgKG1hdGNoVHJpZ2dlcldpZHRoKSB7XG4gICAgc3R5bGUud2lkdGggPSBkcm9wZG93bldpZHRoO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIGhvcml6b250YWwgcG9zaXRpb25cbiAgbGV0IHRyaWdnZXJMZWZ0V2l0aFNjcm9sbCA9IHRyaWdnZXJMZWZ0ICsgc2Nyb2xsLmxlZnQ7XG4gIGlmIChob3Jpem9udGFsUG9zaXRpb24gPT09ICdhdXRvJykge1xuICAgIC8vIENhbGN1bGF0ZSB0aGUgbnVtYmVyIG9mIHZpc2libGUgaG9yaXpvbnRhbCBwaXhlbHMgaWYgd2Ugd2VyZSB0byBwbGFjZSB0aGVcbiAgICAvLyBkcm9wZG93biBvbiB0aGUgbGVmdCBhbmQgcmlnaHRcbiAgICBsZXQgbGVmdFZpc2libGUgPSBNYXRoLm1pbih2aWV3cG9ydFdpZHRoLCB0cmlnZ2VyTGVmdCArIGRyb3Bkb3duV2lkdGgpIC0gTWF0aC5tYXgoMCwgdHJpZ2dlckxlZnQpO1xuICAgIGxldCByaWdodFZpc2libGUgPSBNYXRoLm1pbih2aWV3cG9ydFdpZHRoLCB0cmlnZ2VyTGVmdCArIHRyaWdnZXJXaWR0aCkgLSBNYXRoLm1heCgwLCB0cmlnZ2VyTGVmdCArIHRyaWdnZXJXaWR0aCAtIGRyb3Bkb3duV2lkdGgpO1xuXG4gICAgaWYgKGRyb3Bkb3duV2lkdGggPiBsZWZ0VmlzaWJsZSAmJiByaWdodFZpc2libGUgPiBsZWZ0VmlzaWJsZSkge1xuICAgICAgLy8gSWYgdGhlIGRyb3AgZG93biB3b24ndCBmaXQgbGVmdC1hbGlnbmVkLCBhbmQgdGhlcmUgaXMgbW9yZSBzcGFjZSBvbiB0aGVcbiAgICAgIC8vIHJpZ2h0IHRoYW4gb24gdGhlIGxlZnQsIHRoZW4gZm9yY2UgcmlnaHQtYWxpZ25lZFxuICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uID0gJ3JpZ2h0JztcbiAgICB9IGVsc2UgaWYgKGRyb3Bkb3duV2lkdGggPiByaWdodFZpc2libGUgJiYgbGVmdFZpc2libGUgPiByaWdodFZpc2libGUpIHtcbiAgICAgIC8vIElmIHRoZSBkcm9wIGRvd24gd29uJ3QgZml0IHJpZ2h0LWFsaWduZWQsIGFuZCB0aGVyZSBpcyBtb3JlIHNwYWNlIG9uXG4gICAgICAvLyB0aGUgbGVmdCB0aGFuIG9uIHRoZSByaWdodCwgdGhlbiBmb3JjZSBsZWZ0LWFsaWduZWRcbiAgICAgIGhvcml6b250YWxQb3NpdGlvbiA9ICdsZWZ0JztcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gS2VlcCBzYW1lIHBvc2l0aW9uIGFzIHByZXZpb3VzXG4gICAgICBob3Jpem9udGFsUG9zaXRpb24gPSBwcmV2aW91c0hvcml6b250YWxQb3NpdGlvbiB8fCAnbGVmdCc7XG4gICAgfVxuICB9XG4gIGlmIChob3Jpem9udGFsUG9zaXRpb24gPT09ICdyaWdodCcpIHtcbiAgICBzdHlsZS5yaWdodCA9IHZpZXdwb3J0V2lkdGggLSAodHJpZ2dlckxlZnRXaXRoU2Nyb2xsICsgdHJpZ2dlcldpZHRoKTtcbiAgfSBlbHNlIGlmIChob3Jpem9udGFsUG9zaXRpb24gPT09ICdjZW50ZXInKSB7XG4gICAgc3R5bGUubGVmdCA9IHRyaWdnZXJMZWZ0V2l0aFNjcm9sbCArICh0cmlnZ2VyV2lkdGggLSBkcm9wZG93bldpZHRoKSAvIDI7XG4gIH0gZWxzZSB7XG4gICAgc3R5bGUubGVmdCA9IHRyaWdnZXJMZWZ0V2l0aFNjcm9sbDtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSB2ZXJ0aWNhbCBwb3NpdGlvblxuICBsZXQgdHJpZ2dlclRvcFdpdGhTY3JvbGwgPSB0cmlnZ2VyVG9wICsgc2Nyb2xsLnRvcDtcbiAgaWYgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdhYm92ZScpIHtcbiAgICBzdHlsZS50b3AgPSB0cmlnZ2VyVG9wV2l0aFNjcm9sbCAtIGRyb3Bkb3duSGVpZ2h0O1xuICB9IGVsc2UgaWYgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdiZWxvdycpIHtcbiAgICBzdHlsZS50b3AgPSB0cmlnZ2VyVG9wV2l0aFNjcm9sbCArIHRyaWdnZXJIZWlnaHQ7XG4gIH0gZWxzZSB7XG4gICAgbGV0IHZpZXdwb3J0Qm90dG9tID0gc2Nyb2xsLnRvcCArIHNlbGYud2luZG93LmlubmVySGVpZ2h0O1xuICAgIGxldCBlbm91Z2hSb29tQmVsb3cgPSB0cmlnZ2VyVG9wV2l0aFNjcm9sbCArIHRyaWdnZXJIZWlnaHQgKyBkcm9wZG93bkhlaWdodCA8IHZpZXdwb3J0Qm90dG9tO1xuICAgIGxldCBlbm91Z2hSb29tQWJvdmUgPSB0cmlnZ2VyVG9wID4gZHJvcGRvd25IZWlnaHQ7XG5cbiAgICBpZiAocHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uID09PSAnYmVsb3cnICYmICFlbm91Z2hSb29tQmVsb3cgJiYgZW5vdWdoUm9vbUFib3ZlKSB7XG4gICAgICB2ZXJ0aWNhbFBvc2l0aW9uID0gJ2Fib3ZlJztcbiAgICB9IGVsc2UgaWYgKHByZXZpb3VzVmVydGljYWxQb3NpdGlvbiA9PT0gJ2Fib3ZlJyAmJiAhZW5vdWdoUm9vbUFib3ZlICYmIGVub3VnaFJvb21CZWxvdykge1xuICAgICAgdmVydGljYWxQb3NpdGlvbiA9ICdiZWxvdyc7XG4gICAgfSBlbHNlIGlmICghcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uKSB7XG4gICAgICB2ZXJ0aWNhbFBvc2l0aW9uID0gZW5vdWdoUm9vbUJlbG93ID8gJ2JlbG93JyA6ICdhYm92ZSc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZlcnRpY2FsUG9zaXRpb24gPSBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb247XG4gICAgfVxuICAgIHN0eWxlLnRvcCA9IHRyaWdnZXJUb3BXaXRoU2Nyb2xsICsgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdiZWxvdycgPyB0cmlnZ2VySGVpZ2h0IDogLWRyb3Bkb3duSGVpZ2h0KTtcbiAgfVxuXG4gIHJldHVybiB7IGhvcml6b250YWxQb3NpdGlvbiwgdmVydGljYWxQb3NpdGlvbiwgc3R5bGUgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUluUGxhY2VQb3NpdGlvbihcbiAgICB0cmlnZ2VyOiBFbGVtZW50LFxuICAgIGRyb3Bkb3duOiBFbGVtZW50LFxuICAgIHsgaG9yaXpvbnRhbFBvc2l0aW9uLCB2ZXJ0aWNhbFBvc2l0aW9uIH06IGFueSkge1xuICBsZXQgZHJvcGRvd25SZWN0O1xuICBsZXQgcG9zaXRpb25EYXRhOiBhbnkgPSB7fTtcblxuICBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAnYXV0bycpIHtcbiAgICBsZXQgdHJpZ2dlclJlY3QgPSB0cmlnZ2VyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGRyb3Bkb3duUmVjdCA9IGRyb3Bkb3duLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGxldCB2aWV3cG9ydFJpZ2h0ID0gd2luZG93LnBhZ2VYT2Zmc2V0ICsgd2luZG93LmlubmVyV2lkdGg7XG4gICAgcG9zaXRpb25EYXRhLmhvcml6b250YWxQb3NpdGlvbiA9IHRyaWdnZXJSZWN0LmxlZnQgKyBkcm9wZG93blJlY3Qud2lkdGggPiB2aWV3cG9ydFJpZ2h0ID8gJ3JpZ2h0JyA6ICdsZWZ0JztcbiAgfVxuICBpZiAodmVydGljYWxQb3NpdGlvbiA9PT0gJ2Fib3ZlJykge1xuICAgIHBvc2l0aW9uRGF0YS52ZXJ0aWNhbFBvc2l0aW9uID0gdmVydGljYWxQb3NpdGlvbjtcbiAgICBkcm9wZG93blJlY3QgPSBkcm9wZG93blJlY3QgfHwgZHJvcGRvd24uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgcG9zaXRpb25EYXRhLnN0eWxlID0geyB0b3A6IC1kcm9wZG93blJlY3QuaGVpZ2h0IH07XG4gIH1cbiAgcmV0dXJuIHBvc2l0aW9uRGF0YTtcbn1cbiJdfQ==