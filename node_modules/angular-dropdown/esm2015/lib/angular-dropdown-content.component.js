/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { Component, Input, Host, Inject, forwardRef, NgZone } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { AngularDropdownDirective } from './angular-dropdown.directive';
import { closest, waitForAnimation } from './utils';
/** @type {?} */
const MutationObserver = ((/** @type {?} */ (window))).MutationObserver;
export class AngularDropdownContentComponent {
    /**
     * @param {?} dropdown
     * @param {?} zone
     * @param {?} document
     */
    constructor(dropdown, zone, document) {
        this.dropdown = dropdown;
        this.zone = zone;
        this.dropdownClass = '';
        this.overlay = false;
        this.hasMoved = false;
        this._animationClass = null;
        this.isTouchDevice = 'ontouchstart' in window;
        this.mutationObserver = null;
        this.destroy$ = new Subject();
        this.transitioningInClass = 'ng-dropdown-content--transitioning-in';
        this.transitionedInClass = 'ng-dropdown-content--transitioned-in';
        this.transitioningOutClass = 'ng-dropdown-content--transitioning-out';
        this.shouldOpen = false;
        this.repositionInZone = () => this.zone.run(() => this.dropdown.reposition());
        this.handleRootMouseDown = (e) => {
            if (this.hasMoved ||
                this.dropdownElement.contains((/** @type {?} */ (e.target))) ||
                (this.triggerElement &&
                    this.triggerElement.contains((/** @type {?} */ (e.target))))) {
                this.hasMoved = false;
                return;
            }
            /** @type {?} */
            let closestDropdown = closest((/** @type {?} */ (e.target)), 'ng-dropdown-content');
            if (closestDropdown) {
                /** @type {?} */
                let trigger = this.document.querySelector(`[aria-controls=${closestDropdown.getAttribute('id')}]`);
                /** @type {?} */
                let parentDropdown = closest((/** @type {?} */ (trigger)), 'ng-dropdown-content');
                if (parentDropdown &&
                    parentDropdown.getAttribute('id') === this.dropdown.dropdownId) {
                    this.hasMoved = false;
                    return;
                }
            }
            this.dropdown.close(true);
        };
        this.touchStartHandler = (e) => {
            this.document.body.addEventListener('touchmove', this.touchMoveHandler, true);
        };
        this.touchMoveHandler = (e) => {
            this.hasMoved = true;
            this.document.body.removeEventListener('touchmove', this.touchMoveHandler, true);
        };
        this.document = document;
    }
    /**
     * @return {?}
     */
    get dropdownElement() {
        return this.dropdown.dropdownElement;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.dropdown.onOpen
            .pipe(takeUntil(this.destroy$))
            .subscribe(() => (this.shouldOpen = true));
        this.dropdown.onClose
            .pipe(takeUntil(this.destroy$))
            .subscribe(() => this.close());
    }
    /**
     * @param {?} className
     * @return {?}
     */
    set animationClass(className) {
        if (this._animationClass && className !== this._animationClass) {
            this.dropdownElement.classList.remove(this._animationClass);
        }
        else if (className) {
            this.dropdownElement.classList.add(className);
        }
        this._animationClass = className;
    }
    /**
     * @return {?}
     */
    get animationClass() {
        return this._animationClass;
    }
    /**
     * @return {?}
     */
    get triggerElement() {
        return this.dropdown.triggerElement;
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() {
        if (this.shouldOpen) {
            this.animationClass = this.transitioningInClass;
            requestAnimationFrame(() => this.open());
            this.shouldOpen = false;
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy$.next();
        this.teardownEvents();
    }
    /**
     * @return {?}
     */
    open() {
        this.document.body.addEventListener('mousedown', this.handleRootMouseDown, true);
        if (this.isTouchDevice) {
            this.document.body.addEventListener('touchstart', this.touchStartHandler, true);
            this.document.body.addEventListener('touchend', this.handleRootMouseDown, true);
        }
        /** @type {?} */
        let changes = this.dropdown.reposition();
        if (!this.dropdown.renderInPlace) {
            this.addGlobalEvents();
            this.startObservingDomMutations();
        }
        else if (changes !== null && changes.vPosition === 'above') {
            this.startObservingDomMutations();
        }
        requestAnimationFrame(() => this.animateIn());
    }
    /**
     * @return {?}
     */
    close() {
        this.teardownEvents();
        this.animateOut();
    }
    /**
     * @return {?}
     */
    animateIn() {
        waitForAnimation(this.dropdownElement, () => {
            this.animationClass = this.transitionedInClass;
        });
    }
    /**
     * @return {?}
     */
    animateOut() {
        /** @type {?} */
        let parentElement = this.dropdown.renderInPlace
            ? (/** @type {?} */ (this.dropdownElement.parentElement)).parentElement
            : this.dropdownElement.parentElement;
        /** @type {?} */
        let clone = (/** @type {?} */ (this.dropdownElement.cloneNode(true)));
        clone.id = `${this.dropdownElement.id}--clone`;
        clone.classList.remove(this.transitionedInClass);
        clone.classList.remove(this.transitioningInClass);
        clone.classList.add(this.transitioningOutClass);
        (/** @type {?} */ (parentElement)).appendChild(clone);
        this.animationClass = this.transitioningInClass;
        waitForAnimation(clone, () => (/** @type {?} */ (parentElement)).removeChild(clone));
    }
    /**
     * @return {?}
     */
    startObservingDomMutations() {
        if (MutationObserver) {
            this.mutationObserver = new MutationObserver((mutations) => {
                if (mutations[0].addedNodes.length ||
                    mutations[0].removedNodes.length) {
                    this.repositionInZone();
                }
            });
            (/** @type {?} */ (this.mutationObserver)).observe(this.dropdownElement, {
                childList: true,
                subtree: true
            });
        }
        else {
            this.dropdownElement.addEventListener('DOMNodeInserted', this.repositionInZone, false);
            this.dropdownElement.addEventListener('DOMNodeRemoved', this.repositionInZone, false);
        }
    }
    /**
     * @return {?}
     */
    stopObservingDomMutations() {
        if (MutationObserver) {
            if (this.mutationObserver) {
                this.mutationObserver.disconnect();
                this.mutationObserver = null;
            }
        }
        else {
            if (this.dropdownElement) {
                this.dropdownElement.removeEventListener('DOMNodeInserted', this.repositionInZone);
                this.dropdownElement.removeEventListener('DOMNodeRemoved', this.repositionInZone);
            }
        }
    }
    /**
     * @return {?}
     */
    addGlobalEvents() {
        window.addEventListener('scroll', this.repositionInZone);
        window.addEventListener('resize', this.repositionInZone);
        window.addEventListener('orientationchange', this.repositionInZone);
    }
    /**
     * @return {?}
     */
    removeGlobalEvents() {
        window.removeEventListener('scroll', this.repositionInZone);
        window.removeEventListener('resize', this.repositionInZone);
        window.removeEventListener('orientationchange', this.repositionInZone);
    }
    /**
     * @return {?}
     */
    teardownEvents() {
        this.removeGlobalEvents();
        this.stopObservingDomMutations();
        this.document.body.removeEventListener('mousedown', this.handleRootMouseDown, true);
        if (this.isTouchDevice) {
            this.document.body.removeEventListener('touchstart', this.touchStartHandler, true);
            this.document.body.removeEventListener('touchend', this.handleRootMouseDown, true);
        }
    }
}
AngularDropdownContentComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-dropdown-content,[ng-dropdown-content],[ngDropdownContent]',
                template: "<ng-container *ngIf=\"dropdown.isOpen$ | async as isOpen\">\n  <ng-container *ngWormhole=\"'#ng-dropdown-outlet'; renderInPlace: dropdown.renderInPlace\">\n    <div *ngIf=\"overlay && isOpen\" class=\"ng-dropdown-overlay\"></div>\n    <div [id]=\"dropdown.dropdownId\"\n        class=\"ng-dropdown-content {{dropdownClass}}\"\n        [style.top]=\"(dropdown.position$ | async).top\"\n        [style.right]=\"(dropdown.position$ | async).right\"\n        [style.bottom]=\"(dropdown.position$ | async).bottom\"\n        [style.left]=\"(dropdown.position$ | async).left\"\n        [class.render-in-place]=\"dropdown.renderInPlace\"\n        [class.ng-dropdown-content--above]=\"(dropdown.position$ | async).vPosition === 'above'\"\n        [class.ng-dropdown-content--below]=\"(dropdown.position$ | async).vPosition === 'below'\"\n        [class.ng-dropdown-content--right]=\"(dropdown.position$ | async).hPosition === 'right'\"\n        [class.ng-dropdown-content--center]=\"(dropdown.position$ | async).hPosition === 'center'\"\n        [class.ng-dropdown-content--left]=\"(dropdown.position$ | async).hPosition === 'left'\">\n      <ng-content></ng-content>\n    </div>\n  </ng-container>\n  <div *ngIf=\"!isOpen\" [id]=\"dropdown.dropdownId\" class=\"ng-dropdown-placeholder\"></div>\n</ng-container>\n",
                host: {
                    '[class.render-in-place]': 'dropdown.renderInPlace'
                },
                styles: [":host{display:none}:host.render-in-place{display:block;position:absolute}"]
            }] }
];
AngularDropdownContentComponent.ctorParameters = () => [
    { type: AngularDropdownDirective, decorators: [{ type: Host }, { type: Inject, args: [forwardRef(() => AngularDropdownDirective),] }] },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
AngularDropdownContentComponent.propDecorators = {
    dropdownClass: [{ type: Input }],
    overlay: [{ type: Input }],
    transitioningInClass: [{ type: Input }],
    transitionedInClass: [{ type: Input }],
    transitioningOutClass: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    AngularDropdownContentComponent.prototype.dropdownClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.overlay;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.hasMoved;
    /** @type {?} */
    AngularDropdownContentComponent.prototype._animationClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.isTouchDevice;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.mutationObserver;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.destroy$;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitioningInClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitionedInClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.transitioningOutClass;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.shouldOpen;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.document;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.repositionInZone;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.handleRootMouseDown;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.touchStartHandler;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.touchMoveHandler;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.dropdown;
    /** @type {?} */
    AngularDropdownContentComponent.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItZHJvcGRvd24vIiwic291cmNlcyI6WyJsaWIvYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsSUFBSSxFQUNKLE1BQU0sRUFDTixVQUFVLEVBSVYsTUFBTSxFQUNQLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sU0FBUyxDQUFDOztNQUU5QyxnQkFBZ0IsR0FBRyxDQUFDLG1CQUFBLE1BQU0sRUFBTyxDQUFDLENBQUMsZ0JBQWdCO0FBVXpELE1BQU07Ozs7OztJQTRCSixZQUdTLFFBQWtDLEVBQ2pDLElBQVksRUFDRixRQUFhO1FBRnhCLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2pDLFNBQUksR0FBSixJQUFJLENBQVE7UUE3QnRCLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBR25CLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFFUixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLG9CQUFlLEdBQWtCLElBQUksQ0FBQztRQUN0QyxrQkFBYSxHQUFZLGNBQWMsSUFBSSxNQUFNLENBQUM7UUFDbEQscUJBQWdCLEdBQTRCLElBQUksQ0FBQztRQUNqRCxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUd2Qyx5QkFBb0IsR0FBRyx1Q0FBdUMsQ0FBQztRQUUvRCx3QkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztRQUU3RCwwQkFBcUIsR0FBRyx3Q0FBd0MsQ0FBQztRQU16RCxlQUFVLEdBQUcsS0FBSyxDQUFDO1FBeUZuQixxQkFBZ0IsR0FBRyxHQUFHLEVBQUUsQ0FDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBc0IxQyx3QkFBbUIsR0FBRyxDQUFDLENBQVEsRUFBUSxFQUFFO1lBQy9DLElBQ0UsSUFBSSxDQUFDLFFBQVE7Z0JBQ2IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsbUJBQUEsQ0FBQyxDQUFDLE1BQU0sRUFBVyxDQUFDO2dCQUNsRCxDQUFDLElBQUksQ0FBQyxjQUFjO29CQUNsQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxtQkFBQSxDQUFDLENBQUMsTUFBTSxFQUFXLENBQUMsQ0FBQyxFQUNwRDtnQkFDQSxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztnQkFDdEIsT0FBTzthQUNSOztnQkFFRyxlQUFlLEdBQUcsT0FBTyxDQUFDLG1CQUFBLENBQUMsQ0FBQyxNQUFNLEVBQVcsRUFBRSxxQkFBcUIsQ0FBQztZQUN6RSxJQUFJLGVBQWUsRUFBRTs7b0JBQ2YsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUN2QyxrQkFBa0IsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUN4RDs7b0JBQ0csY0FBYyxHQUFHLE9BQU8sQ0FBQyxtQkFBQSxPQUFPLEVBQUMsRUFBRSxxQkFBcUIsQ0FBQztnQkFDN0QsSUFDRSxjQUFjO29CQUNkLGNBQWMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQzlEO29CQUNBLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO29CQUN0QixPQUFPO2lCQUNSO2FBQ0Y7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUM7UUE4RE0sc0JBQWlCLEdBQUcsQ0FBQyxDQUFRLEVBQUUsRUFBRTtZQUN2QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FDakMsV0FBVyxFQUNYLElBQUksQ0FBQyxnQkFBZ0IsRUFDckIsSUFBSSxDQUNMLENBQUM7UUFDSixDQUFDLENBQUM7UUFFTSxxQkFBZ0IsR0FBRyxDQUFDLENBQVEsRUFBRSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUNwQyxXQUFXLEVBQ1gsSUFBSSxDQUFDLGdCQUFnQixFQUNyQixJQUFJLENBQ0wsQ0FBQztRQUNKLENBQUMsQ0FBQztRQTlNQSxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDOzs7O0lBZkQsSUFBWSxlQUFlO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUM7SUFDdkMsQ0FBQzs7OztJQWVELFFBQVE7UUFDTixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU07YUFDakIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDOUIsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTdDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTzthQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUM5QixTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDbkMsQ0FBQzs7Ozs7SUFFRCxJQUFJLGNBQWMsQ0FBQyxTQUF3QjtRQUN6QyxJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksU0FBUyxLQUFLLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDOUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUM3RDthQUFNLElBQUksU0FBUyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMvQztRQUNELElBQUksQ0FBQyxlQUFlLEdBQUcsU0FBUyxDQUFDO0lBQ25DLENBQUM7Ozs7SUFFRCxJQUFJLGNBQWM7UUFDaEIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzlCLENBQUM7Ozs7SUFFRCxJQUFJLGNBQWM7UUFDaEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQztJQUN0QyxDQUFDOzs7O0lBRUQsa0JBQWtCO1FBQ2hCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztZQUNoRCxxQkFBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztTQUN6QjtJQUNILENBQUM7Ozs7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDeEIsQ0FBQzs7OztJQUVELElBQUk7UUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FDakMsV0FBVyxFQUNYLElBQUksQ0FBQyxtQkFBbUIsRUFDeEIsSUFBSSxDQUNMLENBQUM7UUFFRixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQ2pDLFlBQVksRUFDWixJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLElBQUksQ0FDTCxDQUFDO1lBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQ2pDLFVBQVUsRUFDVixJQUFJLENBQUMsbUJBQW1CLEVBQ3hCLElBQUksQ0FDTCxDQUFDO1NBQ0g7O1lBRUcsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFO1FBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRTtZQUNoQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDdkIsSUFBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7U0FDbkM7YUFBTSxJQUFJLE9BQU8sS0FBSyxJQUFJLElBQUksT0FBTyxDQUFDLFNBQVMsS0FBSyxPQUFPLEVBQUU7WUFDNUQsSUFBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7U0FDbkM7UUFFRCxxQkFBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUNoRCxDQUFDOzs7O0lBRUQsS0FBSztRQUNILElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDcEIsQ0FBQzs7OztJQUtPLFNBQVM7UUFDZixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtZQUMxQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7SUFFTyxVQUFVOztZQUNaLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWE7WUFDN0MsQ0FBQyxDQUFDLG1CQUFBLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFDLENBQUMsYUFBYTtZQUNuRCxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhOztZQUNsQyxLQUFLLEdBQUcsbUJBQUEsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQWU7UUFDL0QsS0FBSyxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxTQUFTLENBQUM7UUFDL0MsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDakQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDbEQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDaEQsbUJBQUEsYUFBYSxFQUFDLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1FBQ2hELGdCQUFnQixDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxtQkFBQSxhQUFhLEVBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDOzs7O0lBK0JPLDBCQUEwQjtRQUNoQyxJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLGdCQUFnQixDQUFDLENBQUMsU0FBYyxFQUFFLEVBQUU7Z0JBQzlELElBQ0UsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNO29CQUM5QixTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFDaEM7b0JBQ0EsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7aUJBQ3pCO1lBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSCxtQkFBQSxJQUFJLENBQUMsZ0JBQWdCLEVBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtnQkFDbkQsU0FBUyxFQUFFLElBQUk7Z0JBQ2YsT0FBTyxFQUFFLElBQUk7YUFDZCxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FDbkMsaUJBQWlCLEVBQ2pCLElBQUksQ0FBQyxnQkFBZ0IsRUFDckIsS0FBSyxDQUNOLENBQUM7WUFDRixJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUNuQyxnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLGdCQUFnQixFQUNyQixLQUFLLENBQ04sQ0FBQztTQUNIO0lBQ0gsQ0FBQzs7OztJQUVPLHlCQUF5QjtRQUMvQixJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUN6QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7YUFDOUI7U0FDRjthQUFNO1lBQ0wsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN4QixJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUN0QyxpQkFBaUIsRUFDakIsSUFBSSxDQUFDLGdCQUFnQixDQUN0QixDQUFDO2dCQUNGLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQ3RDLGdCQUFnQixFQUNoQixJQUFJLENBQUMsZ0JBQWdCLENBQ3RCLENBQUM7YUFDSDtTQUNGO0lBQ0gsQ0FBQzs7OztJQUVPLGVBQWU7UUFDckIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6RCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3pELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN0RSxDQUFDOzs7O0lBRU8sa0JBQWtCO1FBQ3hCLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDNUQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUM1RCxNQUFNLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDekUsQ0FBQzs7OztJQW1CTyxjQUFjO1FBQ3BCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUNwQyxXQUFXLEVBQ1gsSUFBSSxDQUFDLG1CQUFtQixFQUN4QixJQUFJLENBQ0wsQ0FBQztRQUVGLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FDcEMsWUFBWSxFQUNaLElBQUksQ0FBQyxpQkFBaUIsRUFDdEIsSUFBSSxDQUNMLENBQUM7WUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FDcEMsVUFBVSxFQUNWLElBQUksQ0FBQyxtQkFBbUIsRUFDeEIsSUFBSSxDQUNMLENBQUM7U0FDSDtJQUNILENBQUM7OztZQWhSRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLCtEQUErRDtnQkFDekUsb3lDQUF3RDtnQkFFeEQsSUFBSSxFQUFFO29CQUNKLHlCQUF5QixFQUFFLHdCQUF3QjtpQkFDcEQ7O2FBQ0Y7OztZQVpRLHdCQUF3Qix1QkEwQzVCLElBQUksWUFDSixNQUFNLFNBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHdCQUF3QixDQUFDO1lBaERwRCxNQUFNOzRDQW1ESCxNQUFNLFNBQUMsUUFBUTs7OzRCQS9CakIsS0FBSztzQkFHTCxLQUFLO21DQVNMLEtBQUs7a0NBRUwsS0FBSztvQ0FFTCxLQUFLOzs7O0lBaEJOLHdEQUNtQjs7SUFFbkIsa0RBQ2dCOztJQUVoQixtREFBeUI7O0lBQ3pCLDBEQUE4Qzs7SUFDOUMsd0RBQTBEOztJQUMxRCwyREFBeUQ7O0lBQ3pELG1EQUF1Qzs7SUFFdkMsK0RBQytEOztJQUMvRCw4REFDNkQ7O0lBQzdELGdFQUNpRTs7SUFNakUscURBQTJCOztJQUMzQixtREFBMkI7O0lBd0YzQiwyREFDa0Q7O0lBc0JsRCw4REEyQkU7O0lBOERGLDREQU1FOztJQUVGLDJEQU9FOztJQXBOQSxtREFFeUM7O0lBQ3pDLCtDQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgSG9zdCxcbiAgSW5qZWN0LFxuICBmb3J3YXJkUmVmLFxuICBBZnRlclZpZXdDaGVja2VkLFxuICBPbkluaXQsXG4gIE9uRGVzdHJveSxcbiAgTmdab25lXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmltcG9ydCB7IEFuZ3VsYXJEcm9wZG93bkRpcmVjdGl2ZSB9IGZyb20gJy4vYW5ndWxhci1kcm9wZG93bi5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgY2xvc2VzdCwgd2FpdEZvckFuaW1hdGlvbiB9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBNdXRhdGlvbk9ic2VydmVyID0gKHdpbmRvdyBhcyBhbnkpLk11dGF0aW9uT2JzZXJ2ZXI7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25nLWRyb3Bkb3duLWNvbnRlbnQsW25nLWRyb3Bkb3duLWNvbnRlbnRdLFtuZ0Ryb3Bkb3duQ29udGVudF0nLFxuICB0ZW1wbGF0ZVVybDogJy4vYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vYW5ndWxhci1kcm9wZG93bi1jb250ZW50LmNvbXBvbmVudC5jc3MnXSxcbiAgaG9zdDoge1xuICAgICdbY2xhc3MucmVuZGVyLWluLXBsYWNlXSc6ICdkcm9wZG93bi5yZW5kZXJJblBsYWNlJ1xuICB9XG59KVxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJEcm9wZG93bkNvbnRlbnRDb21wb25lbnRcbiAgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0NoZWNrZWQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpXG4gIGRyb3Bkb3duQ2xhc3MgPSAnJztcblxuICBASW5wdXQoKVxuICBvdmVybGF5ID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBoYXNNb3ZlZCA9IGZhbHNlO1xuICBwcml2YXRlIF9hbmltYXRpb25DbGFzczogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgaXNUb3VjaERldmljZTogYm9vbGVhbiA9ICdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdztcbiAgcHJpdmF0ZSBtdXRhdGlvbk9ic2VydmVyOiBNdXRhdGlvbk9ic2VydmVyIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIEBJbnB1dCgpXG4gIHRyYW5zaXRpb25pbmdJbkNsYXNzID0gJ25nLWRyb3Bkb3duLWNvbnRlbnQtLXRyYW5zaXRpb25pbmctaW4nO1xuICBASW5wdXQoKVxuICB0cmFuc2l0aW9uZWRJbkNsYXNzID0gJ25nLWRyb3Bkb3duLWNvbnRlbnQtLXRyYW5zaXRpb25lZC1pbic7XG4gIEBJbnB1dCgpXG4gIHRyYW5zaXRpb25pbmdPdXRDbGFzcyA9ICduZy1kcm9wZG93bi1jb250ZW50LS10cmFuc2l0aW9uaW5nLW91dCc7XG5cbiAgcHJpdmF0ZSBnZXQgZHJvcGRvd25FbGVtZW50KCk6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5kcm9wZG93bi5kcm9wZG93bkVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZE9wZW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEhvc3QoKVxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBBbmd1bGFyRHJvcGRvd25EaXJlY3RpdmUpKVxuICAgIHB1YmxpYyBkcm9wZG93bjogQW5ndWxhckRyb3Bkb3duRGlyZWN0aXZlLFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIGRvY3VtZW50OiBhbnlcbiAgKSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IGRvY3VtZW50O1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5kcm9wZG93bi5vbk9wZW5cbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gKHRoaXMuc2hvdWxkT3BlbiA9IHRydWUpKTtcblxuICAgIHRoaXMuZHJvcGRvd24ub25DbG9zZVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlKCkpO1xuICB9XG5cbiAgc2V0IGFuaW1hdGlvbkNsYXNzKGNsYXNzTmFtZTogc3RyaW5nIHwgbnVsbCkge1xuICAgIGlmICh0aGlzLl9hbmltYXRpb25DbGFzcyAmJiBjbGFzc05hbWUgIT09IHRoaXMuX2FuaW1hdGlvbkNsYXNzKSB7XG4gICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKHRoaXMuX2FuaW1hdGlvbkNsYXNzKTtcbiAgICB9IGVsc2UgaWYgKGNsYXNzTmFtZSkge1xuICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpO1xuICAgIH1cbiAgICB0aGlzLl9hbmltYXRpb25DbGFzcyA9IGNsYXNzTmFtZTtcbiAgfVxuXG4gIGdldCBhbmltYXRpb25DbGFzcygpOiBzdHJpbmcgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5fYW5pbWF0aW9uQ2xhc3M7XG4gIH1cblxuICBnZXQgdHJpZ2dlckVsZW1lbnQoKTogRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuZHJvcGRvd24udHJpZ2dlckVsZW1lbnQ7XG4gIH1cblxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKSB7XG4gICAgaWYgKHRoaXMuc2hvdWxkT3Blbikge1xuICAgICAgdGhpcy5hbmltYXRpb25DbGFzcyA9IHRoaXMudHJhbnNpdGlvbmluZ0luQ2xhc3M7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5vcGVuKCkpO1xuICAgICAgdGhpcy5zaG91bGRPcGVuID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy50ZWFyZG93bkV2ZW50cygpO1xuICB9XG5cbiAgb3BlbigpOiB2b2lkIHtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICdtb3VzZWRvd24nLFxuICAgICAgdGhpcy5oYW5kbGVSb290TW91c2VEb3duLFxuICAgICAgdHJ1ZVxuICAgICk7XG5cbiAgICBpZiAodGhpcy5pc1RvdWNoRGV2aWNlKSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ3RvdWNoc3RhcnQnLFxuICAgICAgICB0aGlzLnRvdWNoU3RhcnRIYW5kbGVyLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICd0b3VjaGVuZCcsXG4gICAgICAgIHRoaXMuaGFuZGxlUm9vdE1vdXNlRG93bixcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBsZXQgY2hhbmdlcyA9IHRoaXMuZHJvcGRvd24ucmVwb3NpdGlvbigpO1xuICAgIGlmICghdGhpcy5kcm9wZG93bi5yZW5kZXJJblBsYWNlKSB7XG4gICAgICB0aGlzLmFkZEdsb2JhbEV2ZW50cygpO1xuICAgICAgdGhpcy5zdGFydE9ic2VydmluZ0RvbU11dGF0aW9ucygpO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlcyAhPT0gbnVsbCAmJiBjaGFuZ2VzLnZQb3NpdGlvbiA9PT0gJ2Fib3ZlJykge1xuICAgICAgdGhpcy5zdGFydE9ic2VydmluZ0RvbU11dGF0aW9ucygpO1xuICAgIH1cblxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLmFuaW1hdGVJbigpKTtcbiAgfVxuXG4gIGNsb3NlKCk6IHZvaWQge1xuICAgIHRoaXMudGVhcmRvd25FdmVudHMoKTtcbiAgICB0aGlzLmFuaW1hdGVPdXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVwb3NpdGlvbkluWm9uZSA9ICgpID0+XG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB0aGlzLmRyb3Bkb3duLnJlcG9zaXRpb24oKSk7XG5cbiAgcHJpdmF0ZSBhbmltYXRlSW4oKTogdm9pZCB7XG4gICAgd2FpdEZvckFuaW1hdGlvbih0aGlzLmRyb3Bkb3duRWxlbWVudCwgKCkgPT4ge1xuICAgICAgdGhpcy5hbmltYXRpb25DbGFzcyA9IHRoaXMudHJhbnNpdGlvbmVkSW5DbGFzcztcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYW5pbWF0ZU91dCgpOiB2b2lkIHtcbiAgICBsZXQgcGFyZW50RWxlbWVudCA9IHRoaXMuZHJvcGRvd24ucmVuZGVySW5QbGFjZVxuICAgICAgPyB0aGlzLmRyb3Bkb3duRWxlbWVudC5wYXJlbnRFbGVtZW50IS5wYXJlbnRFbGVtZW50XG4gICAgICA6IHRoaXMuZHJvcGRvd25FbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgbGV0IGNsb25lID0gdGhpcy5kcm9wZG93bkVsZW1lbnQuY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxFbGVtZW50O1xuICAgIGNsb25lLmlkID0gYCR7dGhpcy5kcm9wZG93bkVsZW1lbnQuaWR9LS1jbG9uZWA7XG4gICAgY2xvbmUuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLnRyYW5zaXRpb25lZEluQ2xhc3MpO1xuICAgIGNsb25lLmNsYXNzTGlzdC5yZW1vdmUodGhpcy50cmFuc2l0aW9uaW5nSW5DbGFzcyk7XG4gICAgY2xvbmUuY2xhc3NMaXN0LmFkZCh0aGlzLnRyYW5zaXRpb25pbmdPdXRDbGFzcyk7XG4gICAgcGFyZW50RWxlbWVudCEuYXBwZW5kQ2hpbGQoY2xvbmUpO1xuICAgIHRoaXMuYW5pbWF0aW9uQ2xhc3MgPSB0aGlzLnRyYW5zaXRpb25pbmdJbkNsYXNzO1xuICAgIHdhaXRGb3JBbmltYXRpb24oY2xvbmUsICgpID0+IHBhcmVudEVsZW1lbnQhLnJlbW92ZUNoaWxkKGNsb25lKSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVJvb3RNb3VzZURvd24gPSAoZTogRXZlbnQpOiB2b2lkID0+IHtcbiAgICBpZiAoXG4gICAgICB0aGlzLmhhc01vdmVkIHx8XG4gICAgICB0aGlzLmRyb3Bkb3duRWxlbWVudC5jb250YWlucyhlLnRhcmdldCBhcyBFbGVtZW50KSB8fFxuICAgICAgKHRoaXMudHJpZ2dlckVsZW1lbnQgJiZcbiAgICAgICAgdGhpcy50cmlnZ2VyRWxlbWVudC5jb250YWlucyhlLnRhcmdldCBhcyBFbGVtZW50KSlcbiAgICApIHtcbiAgICAgIHRoaXMuaGFzTW92ZWQgPSBmYWxzZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgY2xvc2VzdERyb3Bkb3duID0gY2xvc2VzdChlLnRhcmdldCBhcyBFbGVtZW50LCAnbmctZHJvcGRvd24tY29udGVudCcpO1xuICAgIGlmIChjbG9zZXN0RHJvcGRvd24pIHtcbiAgICAgIGxldCB0cmlnZ2VyID0gdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICBgW2FyaWEtY29udHJvbHM9JHtjbG9zZXN0RHJvcGRvd24uZ2V0QXR0cmlidXRlKCdpZCcpfV1gXG4gICAgICApO1xuICAgICAgbGV0IHBhcmVudERyb3Bkb3duID0gY2xvc2VzdCh0cmlnZ2VyISwgJ25nLWRyb3Bkb3duLWNvbnRlbnQnKTtcbiAgICAgIGlmIChcbiAgICAgICAgcGFyZW50RHJvcGRvd24gJiZcbiAgICAgICAgcGFyZW50RHJvcGRvd24uZ2V0QXR0cmlidXRlKCdpZCcpID09PSB0aGlzLmRyb3Bkb3duLmRyb3Bkb3duSWRcbiAgICAgICkge1xuICAgICAgICB0aGlzLmhhc01vdmVkID0gZmFsc2U7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmRyb3Bkb3duLmNsb3NlKHRydWUpO1xuICB9O1xuXG4gIHByaXZhdGUgc3RhcnRPYnNlcnZpbmdEb21NdXRhdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKE11dGF0aW9uT2JzZXJ2ZXIpIHtcbiAgICAgIHRoaXMubXV0YXRpb25PYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChtdXRhdGlvbnM6IGFueSkgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgbXV0YXRpb25zWzBdLmFkZGVkTm9kZXMubGVuZ3RoIHx8XG4gICAgICAgICAgbXV0YXRpb25zWzBdLnJlbW92ZWROb2Rlcy5sZW5ndGhcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5yZXBvc2l0aW9uSW5ab25lKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5tdXRhdGlvbk9ic2VydmVyIS5vYnNlcnZlKHRoaXMuZHJvcGRvd25FbGVtZW50LCB7XG4gICAgICAgIGNoaWxkTGlzdDogdHJ1ZSxcbiAgICAgICAgc3VidHJlZTogdHJ1ZVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZHJvcGRvd25FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdET01Ob2RlSW5zZXJ0ZWQnLFxuICAgICAgICB0aGlzLnJlcG9zaXRpb25JblpvbmUsXG4gICAgICAgIGZhbHNlXG4gICAgICApO1xuICAgICAgdGhpcy5kcm9wZG93bkVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ0RPTU5vZGVSZW1vdmVkJyxcbiAgICAgICAgdGhpcy5yZXBvc2l0aW9uSW5ab25lLFxuICAgICAgICBmYWxzZVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0b3BPYnNlcnZpbmdEb21NdXRhdGlvbnMoKTogdm9pZCB7XG4gICAgaWYgKE11dGF0aW9uT2JzZXJ2ZXIpIHtcbiAgICAgIGlmICh0aGlzLm11dGF0aW9uT2JzZXJ2ZXIpIHtcbiAgICAgICAgdGhpcy5tdXRhdGlvbk9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgdGhpcy5tdXRhdGlvbk9ic2VydmVyID0gbnVsbDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuZHJvcGRvd25FbGVtZW50KSB7XG4gICAgICAgIHRoaXMuZHJvcGRvd25FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgICAgJ0RPTU5vZGVJbnNlcnRlZCcsXG4gICAgICAgICAgdGhpcy5yZXBvc2l0aW9uSW5ab25lXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuZHJvcGRvd25FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgICAgJ0RPTU5vZGVSZW1vdmVkJyxcbiAgICAgICAgICB0aGlzLnJlcG9zaXRpb25JblpvbmVcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZEdsb2JhbEV2ZW50cygpOiB2b2lkIHtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5yZXBvc2l0aW9uSW5ab25lKTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5yZXBvc2l0aW9uSW5ab25lKTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCB0aGlzLnJlcG9zaXRpb25JblpvbmUpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVHbG9iYWxFdmVudHMoKTogdm9pZCB7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMucmVwb3NpdGlvbkluWm9uZSk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgdGhpcy5yZXBvc2l0aW9uSW5ab25lKTtcbiAgfVxuXG4gIHByaXZhdGUgdG91Y2hTdGFydEhhbmRsZXIgPSAoZTogRXZlbnQpID0+IHtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICd0b3VjaG1vdmUnLFxuICAgICAgdGhpcy50b3VjaE1vdmVIYW5kbGVyLFxuICAgICAgdHJ1ZVxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSB0b3VjaE1vdmVIYW5kbGVyID0gKGU6IEV2ZW50KSA9PiB7XG4gICAgdGhpcy5oYXNNb3ZlZCA9IHRydWU7XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAndG91Y2htb3ZlJyxcbiAgICAgIHRoaXMudG91Y2hNb3ZlSGFuZGxlcixcbiAgICAgIHRydWVcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgdGVhcmRvd25FdmVudHMoKSB7XG4gICAgdGhpcy5yZW1vdmVHbG9iYWxFdmVudHMoKTtcbiAgICB0aGlzLnN0b3BPYnNlcnZpbmdEb21NdXRhdGlvbnMoKTtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcihcbiAgICAgICdtb3VzZWRvd24nLFxuICAgICAgdGhpcy5oYW5kbGVSb290TW91c2VEb3duLFxuICAgICAgdHJ1ZVxuICAgICk7XG5cbiAgICBpZiAodGhpcy5pc1RvdWNoRGV2aWNlKSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ3RvdWNoc3RhcnQnLFxuICAgICAgICB0aGlzLnRvdWNoU3RhcnRIYW5kbGVyLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICAgICd0b3VjaGVuZCcsXG4gICAgICAgIHRoaXMuaGFuZGxlUm9vdE1vdXNlRG93bixcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==