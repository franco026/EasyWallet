/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * @param {?} element
 * @param {?} callback
 * @return {?}
 */
export function waitForAnimation(element, callback) {
    requestAnimationFrame(() => {
        /** @type {?} */
        let computedStyle = window.getComputedStyle(element);
        if (computedStyle.animationName !== 'none' &&
            computedStyle.animationPlayState === 'running') {
            return once(element, 'animationend', callback);
        }
        callback();
    });
}
/**
 * @param {?} element
 * @param {?} eventName
 * @param {?} listener
 * @return {?}
 */
function once(element, eventName, listener) {
    element.addEventListener(eventName, function listenOnce(e) {
        element.removeEventListener(eventName, listenOnce);
        return listener(e);
    });
}
/** @type {?} */
export const closest = ((/** @type {?} */ (window))).Element && Element.prototype.closest ?
    (el, s) => el.closest(s) :
    function closest(self, s) {
        /** @type {?} */
        let matches = (((/** @type {?} */ (self))).document || self.ownerDocument).querySelectorAll(s);
        /** @type {?} */
        let i;
        /** @type {?} */
        let el = self;
        do {
            i = matches.length;
            while (--i >= 0 && matches.item(i) !== el) { }
            ;
        } while ((i < 0) && (el = (/** @type {?} */ (el.parentElement))));
        return el;
    };
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculatePosition(trigger, dropdown, { horizontalPosition, verticalPosition, matchTriggerWidth, previousHorizontalPosition, previousVerticalPosition }) {
    // Collect information about all the involved DOM elements
    /** @type {?} */
    let scroll = { left: window.pageXOffset, top: window.pageYOffset };
    let { left: triggerLeft, top: triggerTop, width: triggerWidth, height: triggerHeight } = trigger.getBoundingClientRect();
    let { height: dropdownHeight, width: dropdownWidth } = dropdown.getBoundingClientRect();
    /** @type {?} */
    let viewportWidth = window.innerWidth;
    /** @type {?} */
    let style = {};
    // Calculate drop down width
    dropdownWidth = matchTriggerWidth ? triggerWidth : dropdownWidth;
    if (matchTriggerWidth) {
        style.width = dropdownWidth;
    }
    // Calculate horizontal position
    /** @type {?} */
    let triggerLeftWithScroll = triggerLeft + scroll.left;
    if (horizontalPosition === 'auto') {
        // Calculate the number of visible horizontal pixels if we were to place the
        // dropdown on the left and right
        /** @type {?} */
        let leftVisible = Math.min(viewportWidth, triggerLeft + dropdownWidth) - Math.max(0, triggerLeft);
        /** @type {?} */
        let rightVisible = Math.min(viewportWidth, triggerLeft + triggerWidth) - Math.max(0, triggerLeft + triggerWidth - dropdownWidth);
        if (dropdownWidth > leftVisible && rightVisible > leftVisible) {
            // If the drop down won't fit left-aligned, and there is more space on the
            // right than on the left, then force right-aligned
            horizontalPosition = 'right';
        }
        else if (dropdownWidth > rightVisible && leftVisible > rightVisible) {
            // If the drop down won't fit right-aligned, and there is more space on
            // the left than on the right, then force left-aligned
            horizontalPosition = 'left';
        }
        else {
            // Keep same position as previous
            horizontalPosition = previousHorizontalPosition || 'left';
        }
    }
    if (horizontalPosition === 'right') {
        style.right = viewportWidth - (triggerLeftWithScroll + triggerWidth);
    }
    else if (horizontalPosition === 'center') {
        style.left = triggerLeftWithScroll + (triggerWidth - dropdownWidth) / 2;
    }
    else {
        style.left = triggerLeftWithScroll;
    }
    // Calculate vertical position
    /** @type {?} */
    let triggerTopWithScroll = triggerTop + scroll.top;
    if (verticalPosition === 'above') {
        style.top = triggerTopWithScroll - dropdownHeight;
    }
    else if (verticalPosition === 'below') {
        style.top = triggerTopWithScroll + triggerHeight;
    }
    else {
        /** @type {?} */
        let viewportBottom = scroll.top + self.window.innerHeight;
        /** @type {?} */
        let enoughRoomBelow = triggerTopWithScroll + triggerHeight + dropdownHeight < viewportBottom;
        /** @type {?} */
        let enoughRoomAbove = triggerTop > dropdownHeight;
        if (previousVerticalPosition === 'below' && !enoughRoomBelow && enoughRoomAbove) {
            verticalPosition = 'above';
        }
        else if (previousVerticalPosition === 'above' && !enoughRoomAbove && enoughRoomBelow) {
            verticalPosition = 'below';
        }
        else if (!previousVerticalPosition) {
            verticalPosition = enoughRoomBelow ? 'below' : 'above';
        }
        else {
            verticalPosition = previousVerticalPosition;
        }
        style.top = triggerTopWithScroll + (verticalPosition === 'below' ? triggerHeight : -dropdownHeight);
    }
    return { horizontalPosition, verticalPosition, style };
}
/**
 * @param {?} trigger
 * @param {?} dropdown
 * @param {?} __2
 * @return {?}
 */
export function calculateInPlacePosition(trigger, dropdown, { horizontalPosition, verticalPosition }) {
    /** @type {?} */
    let dropdownRect;
    /** @type {?} */
    let positionData = {};
    if (horizontalPosition === 'auto') {
        /** @type {?} */
        let triggerRect = trigger.getBoundingClientRect();
        dropdownRect = dropdown.getBoundingClientRect();
        /** @type {?} */
        let viewportRight = window.pageXOffset + window.innerWidth;
        positionData.horizontalPosition = triggerRect.left + dropdownRect.width > viewportRight ? 'right' : 'left';
    }
    if (verticalPosition === 'above') {
        positionData.verticalPosition = verticalPosition;
        dropdownRect = dropdownRect || dropdown.getBoundingClientRect();
        positionData.style = { top: -dropdownRect.height };
    }
    return positionData;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE1BQU0sMkJBQTJCLE9BQWdCLEVBQUUsUUFBNEI7SUFDN0UscUJBQXFCLENBQUMsR0FBRyxFQUFFOztZQUNyQixhQUFhLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQztRQUVwRCxJQUFJLGFBQWEsQ0FBQyxhQUFhLEtBQUssTUFBTTtZQUN0QyxhQUFhLENBQUMsa0JBQWtCLEtBQUssU0FBUyxFQUFFO1lBQ2xELE9BQU8sSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDaEQ7UUFFRCxRQUFRLEVBQUUsQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQzs7Ozs7OztBQUVELGNBQWMsT0FBYSxFQUFFLFNBQWlCLEVBQUUsUUFBMkI7SUFDekUsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxvQkFBb0IsQ0FBQztRQUN2RCxPQUFPLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRW5ELE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JCLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQzs7QUFFRCxNQUFNLE9BQU8sT0FBTyxHQUNoQixDQUFDLG1CQUFBLE1BQU0sRUFBTyxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEQsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUIsaUJBQWlCLElBQWEsRUFBRSxDQUFTOztZQUNuQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLG1CQUFBLElBQUksRUFBTyxDQUFDLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7O1lBQzlFLENBQUM7O1lBQ0gsRUFBRSxHQUFHLElBQUk7UUFDVCxHQUFHO1lBQ0QsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDbkIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsR0FBRTtZQUFBLENBQUM7U0FDL0MsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxtQkFBQSxFQUFFLENBQUMsYUFBYSxFQUFDLENBQUMsRUFBRTtRQUM5QyxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7Ozs7Ozs7QUFFTCxNQUFNLDRCQUNKLE9BQWdCLEVBQ2hCLFFBQWlCLEVBQ2pCLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsMEJBQTBCLEVBQUUsd0JBQXdCLEVBQU87OztRQUVsSCxNQUFNLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRTtRQUM5RCxFQUNGLElBQUksRUFBRSxXQUFXLEVBQ2pCLEdBQUcsRUFBRSxVQUFVLEVBQ2YsS0FBSyxFQUFFLFlBQVksRUFDbkIsTUFBTSxFQUFFLGFBQWEsRUFDdEIsR0FBRyxPQUFPLENBQUMscUJBQXFCLEVBQUU7UUFDL0IsRUFDRixNQUFNLEVBQUUsY0FBYyxFQUN0QixLQUFLLEVBQUUsYUFBYSxFQUNyQixHQUFHLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRTs7UUFDaEMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxVQUFVOztRQUNqQyxLQUFLLEdBQVEsRUFBRTtJQUVuQiw0QkFBNEI7SUFDNUIsYUFBYSxHQUFHLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQztJQUNqRSxJQUFJLGlCQUFpQixFQUFFO1FBQ3JCLEtBQUssQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDO0tBQzdCOzs7UUFHRyxxQkFBcUIsR0FBRyxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUk7SUFDckQsSUFBSSxrQkFBa0IsS0FBSyxNQUFNLEVBQUU7Ozs7WUFHN0IsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLFdBQVcsR0FBRyxhQUFhLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUM7O1lBQzdGLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsV0FBVyxHQUFHLFlBQVksR0FBRyxhQUFhLENBQUM7UUFFaEksSUFBSSxhQUFhLEdBQUcsV0FBVyxJQUFJLFlBQVksR0FBRyxXQUFXLEVBQUU7WUFDN0QsMEVBQTBFO1lBQzFFLG1EQUFtRDtZQUNuRCxrQkFBa0IsR0FBRyxPQUFPLENBQUM7U0FDOUI7YUFBTSxJQUFJLGFBQWEsR0FBRyxZQUFZLElBQUksV0FBVyxHQUFHLFlBQVksRUFBRTtZQUNyRSx1RUFBdUU7WUFDdkUsc0RBQXNEO1lBQ3RELGtCQUFrQixHQUFHLE1BQU0sQ0FBQztTQUM3QjthQUFNO1lBQ0wsaUNBQWlDO1lBQ2pDLGtCQUFrQixHQUFHLDBCQUEwQixJQUFJLE1BQU0sQ0FBQztTQUMzRDtLQUNGO0lBQ0QsSUFBSSxrQkFBa0IsS0FBSyxPQUFPLEVBQUU7UUFDbEMsS0FBSyxDQUFDLEtBQUssR0FBRyxhQUFhLEdBQUcsQ0FBQyxxQkFBcUIsR0FBRyxZQUFZLENBQUMsQ0FBQztLQUN0RTtTQUFNLElBQUksa0JBQWtCLEtBQUssUUFBUSxFQUFFO1FBQzFDLEtBQUssQ0FBQyxJQUFJLEdBQUcscUJBQXFCLEdBQUcsQ0FBQyxZQUFZLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQ3pFO1NBQU07UUFDTCxLQUFLLENBQUMsSUFBSSxHQUFHLHFCQUFxQixDQUFDO0tBQ3BDOzs7UUFHRyxvQkFBb0IsR0FBRyxVQUFVLEdBQUcsTUFBTSxDQUFDLEdBQUc7SUFDbEQsSUFBSSxnQkFBZ0IsS0FBSyxPQUFPLEVBQUU7UUFDaEMsS0FBSyxDQUFDLEdBQUcsR0FBRyxvQkFBb0IsR0FBRyxjQUFjLENBQUM7S0FDbkQ7U0FBTSxJQUFJLGdCQUFnQixLQUFLLE9BQU8sRUFBRTtRQUN2QyxLQUFLLENBQUMsR0FBRyxHQUFHLG9CQUFvQixHQUFHLGFBQWEsQ0FBQztLQUNsRDtTQUFNOztZQUNELGNBQWMsR0FBRyxNQUFNLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVzs7WUFDckQsZUFBZSxHQUFHLG9CQUFvQixHQUFHLGFBQWEsR0FBRyxjQUFjLEdBQUcsY0FBYzs7WUFDeEYsZUFBZSxHQUFHLFVBQVUsR0FBRyxjQUFjO1FBRWpELElBQUksd0JBQXdCLEtBQUssT0FBTyxJQUFJLENBQUMsZUFBZSxJQUFJLGVBQWUsRUFBRTtZQUMvRSxnQkFBZ0IsR0FBRyxPQUFPLENBQUM7U0FDNUI7YUFBTSxJQUFJLHdCQUF3QixLQUFLLE9BQU8sSUFBSSxDQUFDLGVBQWUsSUFBSSxlQUFlLEVBQUU7WUFDdEYsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO1NBQzVCO2FBQU0sSUFBSSxDQUFDLHdCQUF3QixFQUFFO1lBQ3BDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7U0FDeEQ7YUFBTTtZQUNMLGdCQUFnQixHQUFHLHdCQUF3QixDQUFDO1NBQzdDO1FBQ0QsS0FBSyxDQUFDLEdBQUcsR0FBRyxvQkFBb0IsR0FBRyxDQUFDLGdCQUFnQixLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0tBQ3JHO0lBRUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ3pELENBQUM7Ozs7Ozs7QUFFRCxNQUFNLG1DQUNGLE9BQWdCLEVBQ2hCLFFBQWlCLEVBQ2pCLEVBQUUsa0JBQWtCLEVBQUUsZ0JBQWdCLEVBQU87O1FBQzNDLFlBQVk7O1FBQ1osWUFBWSxHQUFRLEVBQUU7SUFFMUIsSUFBSSxrQkFBa0IsS0FBSyxNQUFNLEVBQUU7O1lBQzdCLFdBQVcsR0FBRyxPQUFPLENBQUMscUJBQXFCLEVBQUU7UUFDakQsWUFBWSxHQUFHLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDOztZQUM1QyxhQUFhLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsVUFBVTtRQUMxRCxZQUFZLENBQUMsa0JBQWtCLEdBQUcsV0FBVyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsS0FBSyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7S0FDNUc7SUFDRCxJQUFJLGdCQUFnQixLQUFLLE9BQU8sRUFBRTtRQUNoQyxZQUFZLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDakQsWUFBWSxHQUFHLFlBQVksSUFBSSxRQUFRLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUNoRSxZQUFZLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQ3BEO0lBQ0QsT0FBTyxZQUFZLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiB3YWl0Rm9yQW5pbWF0aW9uKGVsZW1lbnQ6IEVsZW1lbnQsIGNhbGxiYWNrOiAoZT86IEV2ZW50KSA9PiBhbnkpOiB2b2lkIHtcbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICBsZXQgY29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpO1xuXG4gICAgaWYgKGNvbXB1dGVkU3R5bGUuYW5pbWF0aW9uTmFtZSAhPT0gJ25vbmUnICYmXG4gICAgICAgIGNvbXB1dGVkU3R5bGUuYW5pbWF0aW9uUGxheVN0YXRlID09PSAncnVubmluZycpIHtcbiAgICAgIHJldHVybiBvbmNlKGVsZW1lbnQsICdhbmltYXRpb25lbmQnLCBjYWxsYmFjayk7XG4gICAgfVxuXG4gICAgY2FsbGJhY2soKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG9uY2UoZWxlbWVudDogTm9kZSwgZXZlbnROYW1lOiBzdHJpbmcsIGxpc3RlbmVyOiAoZTogRXZlbnQpID0+IGFueSk6IHZvaWQge1xuICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jdGlvbiBsaXN0ZW5PbmNlKGUpIHtcbiAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5PbmNlKTtcblxuICAgIHJldHVybiBsaXN0ZW5lcihlKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBjb25zdCBjbG9zZXN0OiAoZWxlbWVudDogRWxlbWVudCwgc2VsZWN0b3I6IHN0cmluZykgPT4gRWxlbWVudCB8IG51bGxcbiAgPSAod2luZG93IGFzIGFueSkuRWxlbWVudCAmJiBFbGVtZW50LnByb3RvdHlwZS5jbG9zZXN0ID9cbiAgICAoZWwsIHMpID0+IGVsLmNsb3Nlc3QocykgOlxuICAgIGZ1bmN0aW9uIGNsb3Nlc3Qoc2VsZjogRWxlbWVudCwgczogc3RyaW5nKSB7XG4gICAgICBsZXQgbWF0Y2hlcyA9ICgoc2VsZiBhcyBhbnkpLmRvY3VtZW50IHx8IHNlbGYub3duZXJEb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbChzKSxcbiAgICAgICAgaSxcbiAgICAgIGVsID0gc2VsZjtcbiAgICAgIGRvIHtcbiAgICAgICAgaSA9IG1hdGNoZXMubGVuZ3RoO1xuICAgICAgICB3aGlsZSAoLS1pID49IDAgJiYgbWF0Y2hlcy5pdGVtKGkpICE9PSBlbCkge307XG4gICAgICB9IHdoaWxlICgoaSA8IDApICYmIChlbCA9IGVsLnBhcmVudEVsZW1lbnQhKSk7XG4gICAgICByZXR1cm4gZWw7XG4gICAgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZVBvc2l0aW9uKFxuICB0cmlnZ2VyOiBFbGVtZW50LFxuICBkcm9wZG93bjogRWxlbWVudCxcbiAgeyBob3Jpem9udGFsUG9zaXRpb24sIHZlcnRpY2FsUG9zaXRpb24sIG1hdGNoVHJpZ2dlcldpZHRoLCBwcmV2aW91c0hvcml6b250YWxQb3NpdGlvbiwgcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uIH06IGFueSk6IGFueSB7XG4gIC8vIENvbGxlY3QgaW5mb3JtYXRpb24gYWJvdXQgYWxsIHRoZSBpbnZvbHZlZCBET00gZWxlbWVudHNcbiAgbGV0IHNjcm9sbCA9IHsgbGVmdDogd2luZG93LnBhZ2VYT2Zmc2V0LCB0b3A6IHdpbmRvdy5wYWdlWU9mZnNldCB9O1xuICBsZXQge1xuICAgIGxlZnQ6IHRyaWdnZXJMZWZ0LFxuICAgIHRvcDogdHJpZ2dlclRvcCxcbiAgICB3aWR0aDogdHJpZ2dlcldpZHRoLFxuICAgIGhlaWdodDogdHJpZ2dlckhlaWdodFxuICB9ID0gdHJpZ2dlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgbGV0IHtcbiAgICBoZWlnaHQ6IGRyb3Bkb3duSGVpZ2h0LFxuICAgIHdpZHRoOiBkcm9wZG93bldpZHRoXG4gIH0gPSBkcm9wZG93bi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgbGV0IHZpZXdwb3J0V2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgbGV0IHN0eWxlOiBhbnkgPSB7fTtcblxuICAvLyBDYWxjdWxhdGUgZHJvcCBkb3duIHdpZHRoXG4gIGRyb3Bkb3duV2lkdGggPSBtYXRjaFRyaWdnZXJXaWR0aCA/IHRyaWdnZXJXaWR0aCA6IGRyb3Bkb3duV2lkdGg7XG4gIGlmIChtYXRjaFRyaWdnZXJXaWR0aCkge1xuICAgIHN0eWxlLndpZHRoID0gZHJvcGRvd25XaWR0aDtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSBob3Jpem9udGFsIHBvc2l0aW9uXG4gIGxldCB0cmlnZ2VyTGVmdFdpdGhTY3JvbGwgPSB0cmlnZ2VyTGVmdCArIHNjcm9sbC5sZWZ0O1xuICBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAnYXV0bycpIHtcbiAgICAvLyBDYWxjdWxhdGUgdGhlIG51bWJlciBvZiB2aXNpYmxlIGhvcml6b250YWwgcGl4ZWxzIGlmIHdlIHdlcmUgdG8gcGxhY2UgdGhlXG4gICAgLy8gZHJvcGRvd24gb24gdGhlIGxlZnQgYW5kIHJpZ2h0XG4gICAgbGV0IGxlZnRWaXNpYmxlID0gTWF0aC5taW4odmlld3BvcnRXaWR0aCwgdHJpZ2dlckxlZnQgKyBkcm9wZG93bldpZHRoKSAtIE1hdGgubWF4KDAsIHRyaWdnZXJMZWZ0KTtcbiAgICBsZXQgcmlnaHRWaXNpYmxlID0gTWF0aC5taW4odmlld3BvcnRXaWR0aCwgdHJpZ2dlckxlZnQgKyB0cmlnZ2VyV2lkdGgpIC0gTWF0aC5tYXgoMCwgdHJpZ2dlckxlZnQgKyB0cmlnZ2VyV2lkdGggLSBkcm9wZG93bldpZHRoKTtcblxuICAgIGlmIChkcm9wZG93bldpZHRoID4gbGVmdFZpc2libGUgJiYgcmlnaHRWaXNpYmxlID4gbGVmdFZpc2libGUpIHtcbiAgICAgIC8vIElmIHRoZSBkcm9wIGRvd24gd29uJ3QgZml0IGxlZnQtYWxpZ25lZCwgYW5kIHRoZXJlIGlzIG1vcmUgc3BhY2Ugb24gdGhlXG4gICAgICAvLyByaWdodCB0aGFuIG9uIHRoZSBsZWZ0LCB0aGVuIGZvcmNlIHJpZ2h0LWFsaWduZWRcbiAgICAgIGhvcml6b250YWxQb3NpdGlvbiA9ICdyaWdodCc7XG4gICAgfSBlbHNlIGlmIChkcm9wZG93bldpZHRoID4gcmlnaHRWaXNpYmxlICYmIGxlZnRWaXNpYmxlID4gcmlnaHRWaXNpYmxlKSB7XG4gICAgICAvLyBJZiB0aGUgZHJvcCBkb3duIHdvbid0IGZpdCByaWdodC1hbGlnbmVkLCBhbmQgdGhlcmUgaXMgbW9yZSBzcGFjZSBvblxuICAgICAgLy8gdGhlIGxlZnQgdGhhbiBvbiB0aGUgcmlnaHQsIHRoZW4gZm9yY2UgbGVmdC1hbGlnbmVkXG4gICAgICBob3Jpem9udGFsUG9zaXRpb24gPSAnbGVmdCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEtlZXAgc2FtZSBwb3NpdGlvbiBhcyBwcmV2aW91c1xuICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uID0gcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb24gfHwgJ2xlZnQnO1xuICAgIH1cbiAgfVxuICBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAncmlnaHQnKSB7XG4gICAgc3R5bGUucmlnaHQgPSB2aWV3cG9ydFdpZHRoIC0gKHRyaWdnZXJMZWZ0V2l0aFNjcm9sbCArIHRyaWdnZXJXaWR0aCk7XG4gIH0gZWxzZSBpZiAoaG9yaXpvbnRhbFBvc2l0aW9uID09PSAnY2VudGVyJykge1xuICAgIHN0eWxlLmxlZnQgPSB0cmlnZ2VyTGVmdFdpdGhTY3JvbGwgKyAodHJpZ2dlcldpZHRoIC0gZHJvcGRvd25XaWR0aCkgLyAyO1xuICB9IGVsc2Uge1xuICAgIHN0eWxlLmxlZnQgPSB0cmlnZ2VyTGVmdFdpdGhTY3JvbGw7XG4gIH1cblxuICAvLyBDYWxjdWxhdGUgdmVydGljYWwgcG9zaXRpb25cbiAgbGV0IHRyaWdnZXJUb3BXaXRoU2Nyb2xsID0gdHJpZ2dlclRvcCArIHNjcm9sbC50b3A7XG4gIGlmICh2ZXJ0aWNhbFBvc2l0aW9uID09PSAnYWJvdmUnKSB7XG4gICAgc3R5bGUudG9wID0gdHJpZ2dlclRvcFdpdGhTY3JvbGwgLSBkcm9wZG93bkhlaWdodDtcbiAgfSBlbHNlIGlmICh2ZXJ0aWNhbFBvc2l0aW9uID09PSAnYmVsb3cnKSB7XG4gICAgc3R5bGUudG9wID0gdHJpZ2dlclRvcFdpdGhTY3JvbGwgKyB0cmlnZ2VySGVpZ2h0O1xuICB9IGVsc2Uge1xuICAgIGxldCB2aWV3cG9ydEJvdHRvbSA9IHNjcm9sbC50b3AgKyBzZWxmLndpbmRvdy5pbm5lckhlaWdodDtcbiAgICBsZXQgZW5vdWdoUm9vbUJlbG93ID0gdHJpZ2dlclRvcFdpdGhTY3JvbGwgKyB0cmlnZ2VySGVpZ2h0ICsgZHJvcGRvd25IZWlnaHQgPCB2aWV3cG9ydEJvdHRvbTtcbiAgICBsZXQgZW5vdWdoUm9vbUFib3ZlID0gdHJpZ2dlclRvcCA+IGRyb3Bkb3duSGVpZ2h0O1xuXG4gICAgaWYgKHByZXZpb3VzVmVydGljYWxQb3NpdGlvbiA9PT0gJ2JlbG93JyAmJiAhZW5vdWdoUm9vbUJlbG93ICYmIGVub3VnaFJvb21BYm92ZSkge1xuICAgICAgdmVydGljYWxQb3NpdGlvbiA9ICdhYm92ZSc7XG4gICAgfSBlbHNlIGlmIChwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb24gPT09ICdhYm92ZScgJiYgIWVub3VnaFJvb21BYm92ZSAmJiBlbm91Z2hSb29tQmVsb3cpIHtcbiAgICAgIHZlcnRpY2FsUG9zaXRpb24gPSAnYmVsb3cnO1xuICAgIH0gZWxzZSBpZiAoIXByZXZpb3VzVmVydGljYWxQb3NpdGlvbikge1xuICAgICAgdmVydGljYWxQb3NpdGlvbiA9IGVub3VnaFJvb21CZWxvdyA/ICdiZWxvdycgOiAnYWJvdmUnO1xuICAgIH0gZWxzZSB7XG4gICAgICB2ZXJ0aWNhbFBvc2l0aW9uID0gcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uO1xuICAgIH1cbiAgICBzdHlsZS50b3AgPSB0cmlnZ2VyVG9wV2l0aFNjcm9sbCArICh2ZXJ0aWNhbFBvc2l0aW9uID09PSAnYmVsb3cnID8gdHJpZ2dlckhlaWdodCA6IC1kcm9wZG93bkhlaWdodCk7XG4gIH1cblxuICByZXR1cm4geyBob3Jpem9udGFsUG9zaXRpb24sIHZlcnRpY2FsUG9zaXRpb24sIHN0eWxlIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVJblBsYWNlUG9zaXRpb24oXG4gICAgdHJpZ2dlcjogRWxlbWVudCxcbiAgICBkcm9wZG93bjogRWxlbWVudCxcbiAgICB7IGhvcml6b250YWxQb3NpdGlvbiwgdmVydGljYWxQb3NpdGlvbiB9OiBhbnkpIHtcbiAgbGV0IGRyb3Bkb3duUmVjdDtcbiAgbGV0IHBvc2l0aW9uRGF0YTogYW55ID0ge307XG5cbiAgaWYgKGhvcml6b250YWxQb3NpdGlvbiA9PT0gJ2F1dG8nKSB7XG4gICAgbGV0IHRyaWdnZXJSZWN0ID0gdHJpZ2dlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBkcm9wZG93blJlY3QgPSBkcm9wZG93bi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBsZXQgdmlld3BvcnRSaWdodCA9IHdpbmRvdy5wYWdlWE9mZnNldCArIHdpbmRvdy5pbm5lcldpZHRoO1xuICAgIHBvc2l0aW9uRGF0YS5ob3Jpem9udGFsUG9zaXRpb24gPSB0cmlnZ2VyUmVjdC5sZWZ0ICsgZHJvcGRvd25SZWN0LndpZHRoID4gdmlld3BvcnRSaWdodCA/ICdyaWdodCcgOiAnbGVmdCc7XG4gIH1cbiAgaWYgKHZlcnRpY2FsUG9zaXRpb24gPT09ICdhYm92ZScpIHtcbiAgICBwb3NpdGlvbkRhdGEudmVydGljYWxQb3NpdGlvbiA9IHZlcnRpY2FsUG9zaXRpb247XG4gICAgZHJvcGRvd25SZWN0ID0gZHJvcGRvd25SZWN0IHx8IGRyb3Bkb3duLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIHBvc2l0aW9uRGF0YS5zdHlsZSA9IHsgdG9wOiAtZHJvcGRvd25SZWN0LmhlaWdodCB9O1xuICB9XG4gIHJldHVybiBwb3NpdGlvbkRhdGE7XG59XG4iXX0=