/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Observable, BehaviorSubject, of } from 'rxjs';
import { skip, first, filter } from 'rxjs/operators';
import { Directive, Attribute, Inject, Input, Output, ContentChild, forwardRef } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { AngularDropdownControlDirective } from './angular-dropdown-control.directive';
import { AngularDropdownContentComponent } from './angular-dropdown-content.component';
import { calculatePosition, calculateInPlacePosition } from './utils';
/**
 * @record
 */
export function AngularDropdownPositionChanges() { }
if (false) {
    /** @type {?} */
    AngularDropdownPositionChanges.prototype.vPosition;
    /** @type {?} */
    AngularDropdownPositionChanges.prototype.hPosition;
}
/** @type {?} */
let id = 1;
/**
 * @return {?}
 */
function generateDropdownId() {
    return id++;
}
/**
 * @record
 */
export function DropdownContentPosition() { }
if (false) {
    /** @type {?} */
    DropdownContentPosition.prototype.hPosition;
    /** @type {?} */
    DropdownContentPosition.prototype.vPosition;
    /** @type {?} */
    DropdownContentPosition.prototype.top;
    /** @type {?} */
    DropdownContentPosition.prototype.left;
    /** @type {?} */
    DropdownContentPosition.prototype.bottom;
    /** @type {?} */
    DropdownContentPosition.prototype.right;
}
/** @type {?} */
const EmptyDropdownContentPosition = Object.freeze({
    vPosition: null,
    hPosition: null,
    top: null,
    left: null,
    bottom: null,
    right: null
});
export class AngularDropdownDirective {
    /**
     * @param {?} document
     * @param {?=} id
     */
    constructor(document, id) {
        this.renderInPlace = false;
        this.control = null;
        this.previousVerticalPosition = null;
        this.previousHorizontalPosition = null;
        this.matchTriggerWidth = false;
        this._isOpen$ = new BehaviorSubject(false);
        this.isOpen$ = this._isOpen$.pipe(skip(1));
        this.position$ = new BehaviorSubject(EmptyDropdownContentPosition);
        this.calculatePosition = calculatePosition;
        this.calculateInPlacePosition = calculateInPlacePosition;
        this.disabled = false;
        this.beforeOpen = null;
        this.beforeClose = null;
        this.verticalPosition = 'auto';
        this.horizontalPosition = 'auto';
        this.onOpen = this.isOpen$.pipe(filter(open => open === true));
        this.onClose = this.isOpen$.pipe(filter(open => open === false));
        this.uniqueId = null;
        this.width = null;
        this.reposition = () => {
            if (!this._isOpen$.getValue()) {
                return null;
            }
            /** @type {?} */
            let dropdownElement = this.dropdownElement;
            if (!dropdownElement || !this.triggerElement) {
                return null;
            }
            /** @type {?} */
            let calculatePosition = this.renderInPlace
                ? this.calculateInPlacePosition
                : this.calculatePosition;
            /** @type {?} */
            let options = {
                horizontalPosition: this.horizontalPosition,
                verticalPosition: this.verticalPosition,
                matchTriggerWidth: this.matchTriggerWidth,
                previousHorizontalPosition: this.previousHorizontalPosition,
                previousVerticalPosition: this.previousVerticalPosition
            };
            /** @type {?} */
            let positionData = calculatePosition(this.triggerElement, dropdownElement, options);
            return this.applyReposition(this.triggerElement, dropdownElement, positionData);
        };
        this.document = document;
        this.initializeId(id);
        this.createDefaultWormholeOutlet();
    }
    /**
     * @return {?}
     */
    get dropdownId() {
        return `ng-dropdown-content-${this.uniqueId}`;
    }
    /**
     * @return {?}
     */
    get triggerElement() {
        return (/** @type {?} */ (this.control)).element.nativeElement;
    }
    /**
     * @return {?}
     */
    get dropdownElement() {
        return (/** @type {?} */ (this.document.getElementById(this.dropdownId)));
    }
    /**
     * @param {?} __0
     * @return {?}
     */
    ngOnChanges({ disabled }) {
        if (disabled &&
            disabled.firstChange === false &&
            disabled.currentValue === true &&
            disabled.previousValue !== true) {
            this.disable();
        }
    }
    /**
     * @return {?}
     */
    open() {
        if (this.disabled || this._isOpen$.getValue()) {
            return;
        }
        /** @type {?} */
        let open$ = of(true);
        if (this.beforeOpen) {
            /** @type {?} */
            const result = this.beforeOpen();
            open$ = result instanceof Observable ? result : of(result);
        }
        open$
            .pipe(first(), filter(open => open === true))
            .subscribe(() => this._isOpen$.next(true));
    }
    /**
     * @param {?=} skipFocus
     * @return {?}
     */
    close(skipFocus = false) {
        if (this.disabled || !this._isOpen$.getValue()) {
            return;
        }
        /** @type {?} */
        let close$ = of(true);
        if (this.beforeClose) {
            /** @type {?} */
            const result = this.beforeClose();
            close$ = result instanceof Observable ? result : of(result);
        }
        close$
            .pipe(first(), filter(close => close === true))
            .subscribe(() => {
            Object.assign(this, {
                hPosition: null,
                vPosition: null,
                top: null,
                right: null,
                bottom: null,
                left: null,
                width: null,
                previousVerticalPosition: null,
                previousHorizontalPosition: null
            });
            this._isOpen$.next(false);
            if (!skipFocus) {
                if (this.triggerElement instanceof HTMLElement &&
                    this.triggerElement.tabIndex > -1) {
                    this.triggerElement.focus();
                }
            }
        });
    }
    /**
     * @return {?}
     */
    toggle() {
        if (this._isOpen$.getValue()) {
            this.close();
        }
        else {
            this.open();
        }
    }
    /**
     * @return {?}
     */
    disable() {
        this.disabled = true;
        this.close();
    }
    /**
     * @return {?}
     */
    enable() {
        this.disabled = false;
    }
    /**
     * @param {?} trigger
     * @param {?} dropdown
     * @param {?} positions
     * @return {?}
     */
    applyReposition(trigger, dropdown, positions) {
        /** @type {?} */
        let changes = {
            hPosition: positions.horizontalPosition,
            vPosition: positions.verticalPosition
        };
        if (positions.style) {
            changes.top = `${positions.style.top}px`;
            // The component can be aligned from the right or from the left, but not from both.
            if (positions.style.left != null) {
                changes.left = `${positions.style.left}px`;
                changes.right = null;
            }
            else if (positions.style.right != null) {
                changes.right = `${positions.style.right}px`;
                changes.left = null;
            }
            if (positions.style.width != null) {
                changes.width = `${positions.style.width}px`;
            }
            if (this.position$.getValue().top == null) {
                // Bypass on the first reposition only to avoid flickering.
                Object.keys(positions.style).forEach(k => (dropdown.style[(/** @type {?} */ (k))] = positions.style[k]));
            }
        }
        this.position$.next(changes);
        this.previousHorizontalPosition = positions.horizontalPosition;
        this.previousVerticalPosition = positions.verticalPosition;
        return changes;
    }
    /**
     * @param {?=} id
     * @return {?}
     */
    initializeId(id) {
        if (id) {
            this.id = this.uniqueId = id;
        }
        else {
            this.uniqueId = generateDropdownId();
            this.id = `ng-dropdown-${this.uniqueId}`;
        }
    }
    /**
     * @return {?}
     */
    createDefaultWormholeOutlet() {
        if (!this.document.getElementById('ng-dropdown-outlet')) {
            /** @type {?} */
            let outlet = this.document.createElement('div');
            outlet.id = 'ng-dropdown-outlet';
            this.document.body.insertBefore(outlet, this.document.body.firstChild);
        }
    }
}
AngularDropdownDirective.decorators = [
    { type: Directive, args: [{
                selector: 'ng-dropdown,[ngDropdown],[ng-dropdown]',
                host: {
                    '[class.render-in-place]': 'renderInPlace',
                    '[class.ng-dropdown]': 'true'
                }
            },] }
];
AngularDropdownDirective.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: String, decorators: [{ type: Attribute, args: ['id',] }] }
];
AngularDropdownDirective.propDecorators = {
    renderInPlace: [{ type: Input }],
    control: [{ type: ContentChild, args: [AngularDropdownControlDirective,] }],
    calculatePosition: [{ type: Input }],
    calculateInPlacePosition: [{ type: Input }],
    disabled: [{ type: Input }],
    beforeOpen: [{ type: Input }],
    beforeClose: [{ type: Input }],
    verticalPosition: [{ type: Input }],
    horizontalPosition: [{ type: Input }],
    onOpen: [{ type: Output, args: ['open',] }],
    onClose: [{ type: Output, args: ['close',] }],
    dropdownContent: [{ type: ContentChild, args: [forwardRef(() => AngularDropdownContentComponent),] }]
};
if (false) {
    /** @type {?} */
    AngularDropdownDirective.prototype.id;
    /** @type {?} */
    AngularDropdownDirective.prototype.renderInPlace;
    /** @type {?} */
    AngularDropdownDirective.prototype.control;
    /** @type {?} */
    AngularDropdownDirective.prototype.previousVerticalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.previousHorizontalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.matchTriggerWidth;
    /** @type {?} */
    AngularDropdownDirective.prototype._isOpen$;
    /** @type {?} */
    AngularDropdownDirective.prototype.isOpen$;
    /** @type {?} */
    AngularDropdownDirective.prototype.position$;
    /** @type {?} */
    AngularDropdownDirective.prototype.calculatePosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.calculateInPlacePosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.disabled;
    /** @type {?} */
    AngularDropdownDirective.prototype.beforeOpen;
    /** @type {?} */
    AngularDropdownDirective.prototype.beforeClose;
    /** @type {?} */
    AngularDropdownDirective.prototype.verticalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.horizontalPosition;
    /** @type {?} */
    AngularDropdownDirective.prototype.onOpen;
    /** @type {?} */
    AngularDropdownDirective.prototype.onClose;
    /** @type {?} */
    AngularDropdownDirective.prototype.dropdownContent;
    /** @type {?} */
    AngularDropdownDirective.prototype.uniqueId;
    /** @type {?} */
    AngularDropdownDirective.prototype.width;
    /** @type {?} */
    AngularDropdownDirective.prototype.document;
    /** @type {?} */
    AngularDropdownDirective.prototype.reposition;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1kcm9wZG93bi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL2FuZ3VsYXItZHJvcGRvd24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckQsT0FBTyxFQUVMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEVBSU4sWUFBWSxFQUtaLFVBQVUsRUFDWCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFM0MsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdkYsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFdkYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLHdCQUF3QixFQUFFLE1BQU0sU0FBUyxDQUFDOzs7O0FBRXRFLG9EQUdDOzs7SUFGQyxtREFBNkI7O0lBQzdCLG1EQUF1Qzs7O0lBR3JDLEVBQUUsR0FBRyxDQUFDOzs7O0FBQ1Y7SUFDRSxPQUFPLEVBQUUsRUFBRSxDQUFDO0FBQ2QsQ0FBQzs7OztBQUtELDZDQU9DOzs7SUFOQyw0Q0FBOEM7O0lBQzlDLDRDQUE0Qzs7SUFDNUMsc0NBQTRCOztJQUM1Qix1Q0FBNkI7O0lBQzdCLHlDQUErQjs7SUFDL0Isd0NBQThCOzs7TUFHMUIsNEJBQTRCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNqRCxTQUFTLEVBQUUsSUFBSTtJQUNmLFNBQVMsRUFBRSxJQUFJO0lBQ2YsR0FBRyxFQUFFLElBQUk7SUFDVCxJQUFJLEVBQUUs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QUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3hFO0lBQ0gsQ0FBQzs7O1lBL1BGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsd0NBQXdDO2dCQUNsRCxJQUFJLEVBQUU7b0JBQ0oseUJBQXlCLEVBQUUsZUFBZTtvQkFDMUMscUJBQXFCLEVBQUUsTUFBTTtpQkFDOUI7YUFDRjs7OzRDQWlFYyxNQUFNLFNBQUMsUUFBUTt5Q0FBa0IsU0FBUyxTQUFDLElBQUk7Ozs0QkE3RDNELEtBQUs7c0JBR0wsWUFBWSxTQUFDLCtCQUErQjtnQ0FrQjVDLEtBQUs7dUNBRUwsS0FBSzt1QkFHTCxLQUFLO3lCQUdMLEtBQUs7MEJBR0wsS0FBSzsrQkFHTCxLQUFLO2lDQUVMLEtBQUs7cUJBR0wsTUFBTSxTQUFDLE1BQU07c0JBR2IsTUFBTSxTQUFDLE9BQU87OEJBV2QsWUFBWSxTQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQywrQkFBK0IsQ0FBQzs7OztJQXhEL0Qsc0NBQVk7O0lBRVosaURBQ3NCOztJQUV0QiwyQ0FDdUQ7O0lBRXZELDREQUF5RDs7SUFDekQsOERBQTZEOztJQUM3RCxxREFBMEI7O0lBRTFCLDRDQUE4Qzs7SUFDOUMsMkNBQXNDOztJQUV0Qyw2Q0FFRTs7SUFNRixxREFDZ0Q7O0lBQ2hELDREQUM4RDs7SUFFOUQsNENBQ2lCOztJQUVqQiw4Q0FDZ0U7O0lBRWhFLCtDQUNpRTs7SUFFakUsb0RBQ21EOztJQUNuRCxzREFDdUQ7O0lBRXZELDBDQUMwRDs7SUFFMUQsMkNBQzREOztJQVU1RCxtREFDMEQ7O0lBRTFELDRDQUFnRDs7SUFDaEQseUNBQW9DOztJQUNwQyw0Q0FBMkI7O0lBa0czQiw4Q0FpQ0UiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBza2lwLCBmaXJzdCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIERpcmVjdGl2ZSxcbiAgQXR0cmlidXRlLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEVsZW1lbnRSZWYsXG4gIEFmdGVyVmlld0luaXQsXG4gIE9uQ2hhbmdlcyxcbiAgQ29udGVudENoaWxkLFxuICBTaW1wbGVDaGFuZ2VzLFxuICBFdmVudEVtaXR0ZXIsXG4gIFF1ZXJ5TGlzdCxcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgZm9yd2FyZFJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5pbXBvcnQgeyBBbmd1bGFyRHJvcGRvd25Db250cm9sRGlyZWN0aXZlIH0gZnJvbSAnLi9hbmd1bGFyLWRyb3Bkb3duLWNvbnRyb2wuZGlyZWN0aXZlJztcbmltcG9ydCB7IEFuZ3VsYXJEcm9wZG93bkNvbnRlbnRDb21wb25lbnQgfSBmcm9tICcuL2FuZ3VsYXItZHJvcGRvd24tY29udGVudC5jb21wb25lbnQnO1xuXG5pbXBvcnQgeyBjYWxjdWxhdGVQb3NpdGlvbiwgY2FsY3VsYXRlSW5QbGFjZVBvc2l0aW9uIH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQW5ndWxhckRyb3Bkb3duUG9zaXRpb25DaGFuZ2VzIHtcbiAgdlBvc2l0aW9uOiAnYWJvdmUnIHwgJ2JlbG93JztcbiAgaFBvc2l0aW9uOiAncmlnaHQnIHwgJ2NlbnRlcicgfCAnbGVmdCc7XG59XG5cbmxldCBpZCA9IDE7XG5mdW5jdGlvbiBnZW5lcmF0ZURyb3Bkb3duSWQoKSB7XG4gIHJldHVybiBpZCsrO1xufVxuXG5leHBvcnQgdHlwZSBWZXJ0aWNhbFBvc2l0aW9uID0gJ2F1dG8nIHwgJ2Fib3ZlJyB8ICdiZWxvdyc7XG5leHBvcnQgdHlwZSBIb3Jpem9udGFsUG9zaXRpb24gPSAnYXV0bycgfCAncmlnaHQnIHwgJ2NlbnRlcicgfCAnbGVmdCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRHJvcGRvd25Db250ZW50UG9zaXRpb24ge1xuICByZWFkb25seSBoUG9zaXRpb246IEhvcml6b250YWxQb3NpdGlvbiB8IG51bGw7XG4gIHJlYWRvbmx5IHZQb3NpdGlvbjogVmVydGljYWxQb3NpdGlvbiB8IG51bGw7XG4gIHJlYWRvbmx5IHRvcDogc3RyaW5nIHwgbnVsbDtcbiAgcmVhZG9ubHkgbGVmdDogc3RyaW5nIHwgbnVsbDtcbiAgcmVhZG9ubHkgYm90dG9tOiBzdHJpbmcgfCBudWxsO1xuICByZWFkb25seSByaWdodDogc3RyaW5nIHwgbnVsbDtcbn1cblxuY29uc3QgRW1wdHlEcm9wZG93bkNvbnRlbnRQb3NpdGlvbiA9IE9iamVjdC5mcmVlemUoe1xuICB2UG9zaXRpb246IG51bGwsXG4gIGhQb3NpdGlvbjogbnVsbCxcbiAgdG9wOiBudWxsLFxuICBsZWZ0OiBudWxsLFxuICBib3R0b206IG51bGwsXG4gIHJpZ2h0OiBudWxsXG59KTtcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnbmctZHJvcGRvd24sW25nRHJvcGRvd25dLFtuZy1kcm9wZG93bl0nLFxuICBob3N0OiB7XG4gICAgJ1tjbGFzcy5yZW5kZXItaW4tcGxhY2VdJzogJ3JlbmRlckluUGxhY2UnLFxuICAgICdbY2xhc3MubmctZHJvcGRvd25dJzogJ3RydWUnXG4gIH1cbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhckRyb3Bkb3duRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgaWQ/OiBzdHJpbmc7XG5cbiAgQElucHV0KClcbiAgcmVuZGVySW5QbGFjZSA9IGZhbHNlO1xuXG4gIEBDb250ZW50Q2hpbGQoQW5ndWxhckRyb3Bkb3duQ29udHJvbERpcmVjdGl2ZSlcbiAgY29udHJvbDogQW5ndWxhckRyb3Bkb3duQ29udHJvbERpcmVjdGl2ZSB8IG51bGwgPSBudWxsO1xuXG4gIHByZXZpb3VzVmVydGljYWxQb3NpdGlvbjogVmVydGljYWxQb3NpdGlvbiB8IG51bGwgPSBudWxsO1xuICBwcmV2aW91c0hvcml6b250YWxQb3NpdGlvbjogSG9yaXpvbnRhbFBvc2l0aW9uIHwgbnVsbCA9IG51bGw7XG4gIG1hdGNoVHJpZ2dlcldpZHRoID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBfaXNPcGVuJCA9IG5ldyBCZWhhdmlvclN1YmplY3QoZmFsc2UpO1xuICBpc09wZW4kID0gdGhpcy5faXNPcGVuJC5waXBlKHNraXAoMSkpO1xuXG4gIHBvc2l0aW9uJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UmVhZG9ubHk8RHJvcGRvd25Db250ZW50UG9zaXRpb24+PihcbiAgICBFbXB0eURyb3Bkb3duQ29udGVudFBvc2l0aW9uXG4gICk7XG5cbiAgZ2V0IGRyb3Bkb3duSWQoKSB7XG4gICAgcmV0dXJuIGBuZy1kcm9wZG93bi1jb250ZW50LSR7dGhpcy51bmlxdWVJZH1gO1xuICB9XG5cbiAgQElucHV0KClcbiAgY2FsY3VsYXRlUG9zaXRpb246IEZ1bmN0aW9uID0gY2FsY3VsYXRlUG9zaXRpb247XG4gIEBJbnB1dCgpXG4gIGNhbGN1bGF0ZUluUGxhY2VQb3NpdGlvbjogRnVuY3Rpb24gPSBjYWxjdWxhdGVJblBsYWNlUG9zaXRpb247XG5cbiAgQElucHV0KClcbiAgZGlzYWJsZWQgPSBmYWxzZTtcblxuICBASW5wdXQoKVxuICBiZWZvcmVPcGVuOiAoKCkgPT4gYm9vbGVhbiB8IE9ic2VydmFibGU8Ym9vbGVhbj4pIHwgbnVsbCA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgYmVmb3JlQ2xvc2U6ICgoKSA9PiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPikgfCBudWxsID0gbnVsbDtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgdmVydGljYWxQb3NpdGlvbjogVmVydGljYWxQb3NpdGlvbiA9ICdhdXRvJztcbiAgQElucHV0KClcbiAgcHVibGljIGhvcml6b250YWxQb3NpdGlvbjogSG9yaXpvbnRhbFBvc2l0aW9uID0gJ2F1dG8nO1xuXG4gIEBPdXRwdXQoJ29wZW4nKVxuICBvbk9wZW4gPSB0aGlzLmlzT3BlbiQucGlwZShmaWx0ZXIob3BlbiA9PiBvcGVuID09PSB0cnVlKSk7XG5cbiAgQE91dHB1dCgnY2xvc2UnKVxuICBvbkNsb3NlID0gdGhpcy5pc09wZW4kLnBpcGUoZmlsdGVyKG9wZW4gPT4gb3BlbiA9PT0gZmFsc2UpKTtcblxuICBnZXQgdHJpZ2dlckVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLmNvbnRyb2whLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIGdldCBkcm9wZG93bkVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuZHJvcGRvd25JZCkhO1xuICB9XG5cbiAgQENvbnRlbnRDaGlsZChmb3J3YXJkUmVmKCgpID0+IEFuZ3VsYXJEcm9wZG93bkNvbnRlbnRDb21wb25lbnQpKVxuICBwcml2YXRlIGRyb3Bkb3duQ29udGVudD86IEFuZ3VsYXJEcm9wZG93bkNvbnRlbnRDb21wb25lbnQ7XG5cbiAgcHJpdmF0ZSB1bmlxdWVJZDogbnVtYmVyIHwgc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgd2lkdGg6IG51bWJlciB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGRvY3VtZW50OiBEb2N1bWVudDtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBkb2N1bWVudDogYW55LCBAQXR0cmlidXRlKCdpZCcpIGlkPzogc3RyaW5nKSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IGRvY3VtZW50O1xuICAgIHRoaXMuaW5pdGlhbGl6ZUlkKGlkKTtcbiAgICB0aGlzLmNyZWF0ZURlZmF1bHRXb3JtaG9sZU91dGxldCgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoeyBkaXNhYmxlZCB9OiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgZGlzYWJsZWQgJiZcbiAgICAgIGRpc2FibGVkLmZpcnN0Q2hhbmdlID09PSBmYWxzZSAmJlxuICAgICAgZGlzYWJsZWQuY3VycmVudFZhbHVlID09PSB0cnVlICYmXG4gICAgICBkaXNhYmxlZC5wcmV2aW91c1ZhbHVlICE9PSB0cnVlXG4gICAgKSB7XG4gICAgICB0aGlzLmRpc2FibGUoKTtcbiAgICB9XG4gIH1cblxuICBvcGVuKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRpc2FibGVkIHx8IHRoaXMuX2lzT3BlbiQuZ2V0VmFsdWUoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBvcGVuJCA9IG9mKHRydWUpO1xuXG4gICAgaWYgKHRoaXMuYmVmb3JlT3Blbikge1xuICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5iZWZvcmVPcGVuKCk7XG4gICAgICBvcGVuJCA9IHJlc3VsdCBpbnN0YW5jZW9mIE9ic2VydmFibGUgPyByZXN1bHQgOiBvZihyZXN1bHQpO1xuICAgIH1cblxuICAgIG9wZW4kXG4gICAgICAucGlwZShcbiAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgZmlsdGVyKG9wZW4gPT4gb3BlbiA9PT0gdHJ1ZSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5faXNPcGVuJC5uZXh0KHRydWUpKTtcbiAgfVxuXG4gIGNsb3NlKHNraXBGb2N1cyA9IGZhbHNlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQgfHwgIXRoaXMuX2lzT3BlbiQuZ2V0VmFsdWUoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBjbG9zZSQgPSBvZih0cnVlKTtcblxuICAgIGlmICh0aGlzLmJlZm9yZUNsb3NlKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLmJlZm9yZUNsb3NlKCk7XG4gICAgICBjbG9zZSQgPSByZXN1bHQgaW5zdGFuY2VvZiBPYnNlcnZhYmxlID8gcmVzdWx0IDogb2YocmVzdWx0KTtcbiAgICB9XG5cbiAgICBjbG9zZSRcbiAgICAgIC5waXBlKFxuICAgICAgICBmaXJzdCgpLFxuICAgICAgICBmaWx0ZXIoY2xvc2UgPT4gY2xvc2UgPT09IHRydWUpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgICAgICAgaFBvc2l0aW9uOiBudWxsLFxuICAgICAgICAgIHZQb3NpdGlvbjogbnVsbCxcbiAgICAgICAgICB0b3A6IG51bGwsXG4gICAgICAgICAgcmlnaHQ6IG51bGwsXG4gICAgICAgICAgYm90dG9tOiBudWxsLFxuICAgICAgICAgIGxlZnQ6IG51bGwsXG4gICAgICAgICAgd2lkdGg6IG51bGwsXG4gICAgICAgICAgcHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uOiBudWxsLFxuICAgICAgICAgIHByZXZpb3VzSG9yaXpvbnRhbFBvc2l0aW9uOiBudWxsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9pc09wZW4kLm5leHQoZmFsc2UpO1xuXG4gICAgICAgIGlmICghc2tpcEZvY3VzKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy50cmlnZ2VyRWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmXG4gICAgICAgICAgICB0aGlzLnRyaWdnZXJFbGVtZW50LnRhYkluZGV4ID4gLTFcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQuZm9jdXMoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgdG9nZ2xlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9pc09wZW4kLmdldFZhbHVlKCkpIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5vcGVuKCk7XG4gICAgfVxuICB9XG5cbiAgZGlzYWJsZSgpOiB2b2lkIHtcbiAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTtcbiAgICB0aGlzLmNsb3NlKCk7XG4gIH1cblxuICBlbmFibGUoKTogdm9pZCB7XG4gICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlO1xuICB9XG5cbiAgcmVwb3NpdGlvbiA9ICgpOiBBbmd1bGFyRHJvcGRvd25Qb3NpdGlvbkNoYW5nZXMgfCBudWxsID0+IHtcbiAgICBpZiAoIXRoaXMuX2lzT3BlbiQuZ2V0VmFsdWUoKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgbGV0IGRyb3Bkb3duRWxlbWVudCA9IHRoaXMuZHJvcGRvd25FbGVtZW50O1xuICAgIGlmICghZHJvcGRvd25FbGVtZW50IHx8ICF0aGlzLnRyaWdnZXJFbGVtZW50KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBsZXQgY2FsY3VsYXRlUG9zaXRpb24gPSB0aGlzLnJlbmRlckluUGxhY2VcbiAgICAgID8gdGhpcy5jYWxjdWxhdGVJblBsYWNlUG9zaXRpb25cbiAgICAgIDogdGhpcy5jYWxjdWxhdGVQb3NpdGlvbjtcblxuICAgIGxldCBvcHRpb25zID0ge1xuICAgICAgaG9yaXpvbnRhbFBvc2l0aW9uOiB0aGlzLmhvcml6b250YWxQb3NpdGlvbixcbiAgICAgIHZlcnRpY2FsUG9zaXRpb246IHRoaXMudmVydGljYWxQb3NpdGlvbixcbiAgICAgIG1hdGNoVHJpZ2dlcldpZHRoOiB0aGlzLm1hdGNoVHJpZ2dlcldpZHRoLFxuICAgICAgcHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb246IHRoaXMucHJldmlvdXNIb3Jpem9udGFsUG9zaXRpb24sXG4gICAgICBwcmV2aW91c1ZlcnRpY2FsUG9zaXRpb246IHRoaXMucHJldmlvdXNWZXJ0aWNhbFBvc2l0aW9uXG4gICAgfTtcblxuICAgIGxldCBwb3NpdGlvbkRhdGEgPSBjYWxjdWxhdGVQb3NpdGlvbihcbiAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQsXG4gICAgICBkcm9wZG93bkVsZW1lbnQsXG4gICAgICBvcHRpb25zXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmFwcGx5UmVwb3NpdGlvbihcbiAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQsXG4gICAgICBkcm9wZG93bkVsZW1lbnQsXG4gICAgICBwb3NpdGlvbkRhdGFcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgYXBwbHlSZXBvc2l0aW9uKFxuICAgIHRyaWdnZXI6IEVsZW1lbnQsXG4gICAgZHJvcGRvd246IEhUTUxFbGVtZW50LFxuICAgIHBvc2l0aW9uczogYW55XG4gICk6IEFuZ3VsYXJEcm9wZG93blBvc2l0aW9uQ2hhbmdlcyB7XG4gICAgbGV0IGNoYW5nZXM6IGFueSA9IHtcbiAgICAgIGhQb3NpdGlvbjogcG9zaXRpb25zLmhvcml6b250YWxQb3NpdGlvbixcbiAgICAgIHZQb3NpdGlvbjogcG9zaXRpb25zLnZlcnRpY2FsUG9zaXRpb25cbiAgICB9O1xuICAgIGlmIChwb3NpdGlvbnMuc3R5bGUpIHtcbiAgICAgIGNoYW5nZXMudG9wID0gYCR7cG9zaXRpb25zLnN0eWxlLnRvcH1weGA7XG4gICAgICAvLyBUaGUgY29tcG9uZW50IGNhbiBiZSBhbGlnbmVkIGZyb20gdGhlIHJpZ2h0IG9yIGZyb20gdGhlIGxlZnQsIGJ1dCBub3QgZnJvbSBib3RoLlxuICAgICAgaWYgKHBvc2l0aW9ucy5zdHlsZS5sZWZ0ICE9IG51bGwpIHtcbiAgICAgICAgY2hhbmdlcy5sZWZ0ID0gYCR7cG9zaXRpb25zLnN0eWxlLmxlZnR9cHhgO1xuICAgICAgICBjaGFuZ2VzLnJpZ2h0ID0gbnVsbDtcbiAgICAgIH0gZWxzZSBpZiAocG9zaXRpb25zLnN0eWxlLnJpZ2h0ICE9IG51bGwpIHtcbiAgICAgICAgY2hhbmdlcy5yaWdodCA9IGAke3Bvc2l0aW9ucy5zdHlsZS5yaWdodH1weGA7XG4gICAgICAgIGNoYW5nZXMubGVmdCA9IG51bGw7XG4gICAgICB9XG4gICAgICBpZiAocG9zaXRpb25zLnN0eWxlLndpZHRoICE9IG51bGwpIHtcbiAgICAgICAgY2hhbmdlcy53aWR0aCA9IGAke3Bvc2l0aW9ucy5zdHlsZS53aWR0aH1weGA7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5wb3NpdGlvbiQuZ2V0VmFsdWUoKS50b3AgPT0gbnVsbCkge1xuICAgICAgICAvLyBCeXBhc3Mgb24gdGhlIGZpcnN0IHJlcG9zaXRpb24gb25seSB0byBhdm9pZCBmbGlja2VyaW5nLlxuICAgICAgICBPYmplY3Qua2V5cyhwb3NpdGlvbnMuc3R5bGUpLmZvckVhY2goXG4gICAgICAgICAgayA9PiAoZHJvcGRvd24uc3R5bGVbayBhcyBhbnldID0gcG9zaXRpb25zLnN0eWxlW2tdKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMucG9zaXRpb24kLm5leHQoY2hhbmdlcyk7XG5cbiAgICB0aGlzLnByZXZpb3VzSG9yaXpvbnRhbFBvc2l0aW9uID0gcG9zaXRpb25zLmhvcml6b250YWxQb3NpdGlvbjtcbiAgICB0aGlzLnByZXZpb3VzVmVydGljYWxQb3NpdGlvbiA9IHBvc2l0aW9ucy52ZXJ0aWNhbFBvc2l0aW9uO1xuXG4gICAgcmV0dXJuIGNoYW5nZXM7XG4gIH1cblxuICBwcml2YXRlIGluaXRpYWxpemVJZChpZD86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChpZCkge1xuICAgICAgdGhpcy5pZCA9IHRoaXMudW5pcXVlSWQgPSBpZDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51bmlxdWVJZCA9IGdlbmVyYXRlRHJvcGRvd25JZCgpO1xuICAgICAgdGhpcy5pZCA9IGBuZy1kcm9wZG93bi0ke3RoaXMudW5pcXVlSWR9YDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURlZmF1bHRXb3JtaG9sZU91dGxldCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25nLWRyb3Bkb3duLW91dGxldCcpKSB7XG4gICAgICBsZXQgb3V0bGV0ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIG91dGxldC5pZCA9ICduZy1kcm9wZG93bi1vdXRsZXQnO1xuICAgICAgdGhpcy5kb2N1bWVudC5ib2R5Lmluc2VydEJlZm9yZShvdXRsZXQsIHRoaXMuZG9jdW1lbnQuYm9keS5maXJzdENoaWxkKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==